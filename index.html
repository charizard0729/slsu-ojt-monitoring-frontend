<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SLSU Catanauan Internship Monitoring System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html-docx-js/dist/html-docx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
 
  <style>
    body {
      background: linear-gradient(120deg, #a7ffeb 0%, #79857a 100%);
      margin: 0;
      font-family: 'Poppins', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .banner {
      background: linear-gradient(90deg, #00695c, #43a047);
      color: #fff;
      font-size: 2.2rem;
      font-weight: bold;
      padding: 20px 300px;
      border-radius: 0px;
      margin-bottom: 60px;
      box-shadow: 0 4px 22px rgba(0,0,0,0.13);
      text-align: center;
      letter-spacing: 1px;
    }
    .btn-group {
      display: flex;
      gap: 38px;
      justify-content: center;
    }
    .select-btn {
      background: linear-gradient(90deg, #388e3c, #00bfae);
      color: #fff;
      border: none;
      padding: 26px 60px;
      font-size: 1.3rem;
      font-weight: 600;
      border-radius: 0px;
      cursor: pointer;
      box-shadow: 0 2px 14px rgba(0,0,0,0.09);
      transition: transform 0.15s, background 0.15s;
    }
    .select-btn:hover {
      background: linear-gradient(90deg, #00bfae, #388e3c);
      transform: scale(1.05);
    }
    .login-form {
      display: none;
      background: #fff;
      border-radius: 0px;
      box-shadow: 0 4px 18px rgba(0,0,0,0.10);
      padding: 34px 30px;
      margin-top: 16px;
      min-width: 300px;
      max-width: 350px;
      text-align: center;
      position: relative;
      animation: fadeIn .5s;
    }
    .login-form h2 {
      font-size: 1.4rem;
      color: #00695c;
      margin-bottom: 18px;
    }
    .login-form input {
      width: 94%;
      padding: 14px;
      margin: 10px 0;
      border-radius: 10px;
      border: 0px solid #b2dfdb;
      font-size: 1rem;
      outline: none;
      background: #f1f8e9;
    }
    .login-form .form-btn {
      background: linear-gradient(90deg, #1a1d1f, #43a047);
      color: #fff;
      border: none;
      border-radius: 0px;
      font-size: 1.1rem;
      font-weight: 600;
      padding: 13px 0;
      width: 100%;
      margin-top: 12px;
      cursor: pointer;
      transition: background 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .login-form .form-btn:hover {
      background: linear-gradient(90deg, #2495e6, #1a1d1f);
    }
    .login-form .create-btn {
      background: linear-gradient(90deg, #1a1d1f, #43a047);
      color: #fff;
      border: none;
      border-radius: 0px;
      font-size: 1.1rem;
      font-weight: 600;
      padding: 13px 0;
      width: 100%;
      margin-top: 12px;
      cursor: pointer;
      transition: background 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .login-form .create-btn:hover {
      background: linear-gradient(90deg, #43a047, #1565c0);
    }
    .back-btn {
  background: #e0e0e0;
  color: #00695c;
  border: none;
  font-size: 1.15rem;
  cursor: pointer;
  margin-top: 18px;
  font-weight: 600;
  padding: 13px 0;
  border-radius: 0px;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  transition: background 0.13s;
}
.back-btn i {
  font-size: 1.3rem;
  margin-right: 8px;
}
.back-btn:hover {
  background: #bdbdbd;
  color: #222;
}
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(30px);}
      to { opacity: 1; transform: translateY(0);}
    }
    @media (max-width: 600px) {
      .banner { font-size: 1.2rem; padding: 18px 10px; margin-bottom: 32px;}
      .btn-group { flex-direction: column; gap: 22px;}
      .select-btn { font-size: 1rem; padding: 18px 20px;}
      .login-form { min-width: 88vw; max-width: 98vw; padding: 18px 6vw;}
    }
    .class-management {
      display: none;
      background: #fff;
      border-radius: 0px;
      box-shadow: 0 4px 18px rgba(0,0,0,0.10);
      padding: 34px 30px;
      margin-top: 22px;
      min-width: 300px;
      max-width: 400px;
      text-align: center;
      animation: fadeIn .6s;
    }
    .class-management h2 {
      margin-bottom: 18px;
      color: #00695c;
      font-size: 1.4rem;
      font-weight: 600;
    }
    .class-management input {
      width: 94%;
      padding: 13px;
      margin: 10px 0;
      border-radius: 10px;
      border: 1.5px solid #b2dfdb;
      font-size: 1rem;
      outline: none;
      background: #f1f8e9;
    }
    .class-management .form-btn {
      background: linear-gradient(90deg, #388e3c, #00bfae);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: 600;
      padding: 13px 0;
      width: 100%;
      margin-top: 12px;
      cursor: pointer;
      transition: background 0.15s;
      margin-bottom: 14px;
    }
    .class-management .form-btn:hover {
      background: linear-gradient(90deg, #00bfae, #388e3c);
    }
    .class-management .class-list {
      text-align: left;
      margin-top: 18px;
    }
    .class-management .class-item {
      background: #eafaf5;
      margin-bottom: 10px;
      padding: 12px;
      border-radius: 8px;
      font-size: 1rem;
      box-shadow: 0 2px 8px #eee;
    }
    .dept-modal-card {
  background: linear-gradient(120deg, #e3f7ef 0%, #fafcfb 100%);
  padding: 34px 30px 18px 30px;
  border-radius: 22px;
  min-width: 320px;
  max-width: 370px;
  margin: auto;
  box-shadow: 0 6px 32px #00695c33;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.dept-modal-title {
  color: #00695c;
  font-size: 1.25rem;
  font-weight: 700;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 9px;
}
.dept-section {
  width: 100%;
}
.dept-list {
  list-style: none;
  margin: 12px 0 0 0;
  padding: 0;
}
.dept-list li {
  background: #eafaf5;
  border-radius: 8px;
  margin-bottom: 8px;
  padding: 8px 13px;
  font-size: 1.05rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.dept-list .dept-btn-action {
  background: linear-gradient(90deg, #2495e6, #43a047);
  color: #fff;
  border: none;
  border-radius: 6px;
  font-size: 0.9rem;
  padding: 4px 10px;
  margin-left: 6px;
  cursor: pointer;
  transition: background 0.15s;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}
.dept-list .dept-btn-action:hover {
  background: linear-gradient(90deg, #43a047, #2495e6);
}
.dept-add-group {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}
.dept-input {
  flex: 1;
  padding: 8px 12px;
  border-radius: 8px;
  border: 1.5px solid #b2dfdb;
  font-size: 1rem;
  background: #f1f8e9;
  outline: none;
}
.dept-btn-add {
  background: linear-gradient(90deg, #2495e6, #43a047);
  color: #fff;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 500;
  padding: 7px 18px;
  cursor: pointer;
  transition: background 0.15s;
  display: flex;
  align-items: center;
  gap: 7px;
}
.dept-btn-add:hover {
  background: linear-gradient(90deg, #43a047, #2495e6);
}
.dept-btn-done {
  background: #e0e0e0;
  color: #00695c;
  border: none;
  font-size: 1.15rem;
  cursor: pointer;
  font-weight: 600;
  padding: 13px 0;
  border-radius: 10px;
  width: 100%;
  margin-top: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  transition: background 0.13s;
}
.dept-btn-done i {
  font-size: 1.3rem;
  margin-right: 8px;
}
.dept-btn-done:hover {
  background: #bdbdbd;
  color: #222;
}
.dashboard-header {
  background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
  padding: 28px 38px;
  border-radius: 16px;
  box-shadow: 0 4px 18px rgba(60, 100, 100, 0.13);
  margin-bottom: 28px;
  margin-top: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  max-width: 800px;
  min-width: 340px;
  margin-left: auto;
  margin-right: auto;
}

.dashboard-header .dashboard-title {
  font-size: 1.55rem;
  font-weight: 700;
  color: #11695c;
  letter-spacing: 1px;
  text-shadow: 0 2px 10px rgba(67,169,71,0.08);
  display: flex;
  align-items: center;
  gap: 12px;
}

.dashboard-header .dashboard-title i {
  color: #25a55f;
  font-size: 1.45rem;
  margin-right: 8px;
}
.dashboard-nav {
  display: flex;
  gap: 10px;
  background: transparent;
  padding: 10px 0;
  align-items: center;
}

.dashboard-nav-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  background: #f8faf9;
  border: 1.5px solid #b2dfdb;
  color: #223046;
  font-family: inherit;
  font-size: 1rem;
  font-weight: 500;
  padding: 7px 18px 7px 14px;
  border-radius: 9px;
  cursor: pointer;
  box-shadow: 0 2px 8px #aacfc333;
  transition: 
    background 0.15s,
    border-color 0.15s,
    color 0.15s,
    box-shadow 0.13s,
    transform 0.13s;
  outline: none;
}

.dashboard-nav-btn i {
  font-size: 1.13rem;
}

.dashboard-nav-btn:hover,
.dashboard-nav-btn:focus {
  background: #e0f7fa;
  border-color: #43a047;
  color: #18684b;
  box-shadow: 0 4px 14px #43a04722;
  transform: translateY(-2px) scale(1.03);
}

.dashboard-nav-btn.active {
  background: linear-gradient(90deg, #43a047 70%, #25a55f 100%);
  color: #fff;
  border-color: #43a047;
  box-shadow: 0 4px 16px #43a04733;
  font-weight: 700;
}
.enroll-student-container {
  margin: 50px auto;
  max-width: 820px;
  background: #fff;
  border-radius: 24px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.08);
  padding: 40px 40px 30px 40px;
  text-align: center;
  position: relative;
}
.enroll-header {
  font-size: 1.35rem;
  color: #18684b;
  font-weight: 700;
  margin-bottom: 30px;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
}
.enroll-row {
  display: flex;
  gap: 18px;
  margin-bottom: 18px;
}
.enroll-row input,
.enroll-row select {
  flex: 1 1 0;
  min-width: 0;
  padding: 16px 16px;
  border-radius: 13px;
  border: 1.5px solid #d3eede;
  background: #f6fff7;
  font-size: 1rem;
  transition: border-color 0.2s;
  box-sizing: border-box;
}
.enroll-row input:focus,
.enroll-row select:focus {
  border-color: #43a047;
  outline: none;
}
.enroll-actions {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 18px;
  margin-top: 22px;
}
.enroll-btn {
  background: linear-gradient(90deg, #25a55f 0%, #36d1c4 100%);
  color: #fff;
  border: none;
  border-radius: 10px;
  font-size: 1.09rem;
  font-weight: 600;
  padding: 15px 30px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: background 0.2s, transform 0.15s;
}
.enroll-btn:hover {
  background: linear-gradient(90deg, #36d1c4 0%, #25a55f 100%);
  transform: scale(1.05);
}
.excel-label {
  background: #eafaf5;
  color: #2495e6;
  border-radius: 8px;
  padding: 10px 18px;
  cursor: pointer;
  font-weight: 600;
  font-size: 1.05rem;
  transition: background 0.13s;
  display: flex;
  align-items: center;
  gap: 8px;
  border: none;
}
.excel-label:hover {
  background: #b2dfdb;
}
@media (max-width: 900px) {
  .enroll-student-container {
    max-width: 99vw;
    padding: 18px 6vw;
  }
  .enroll-row {
    flex-direction: column;
    gap: 10px;
  }
  .enroll-actions {
    flex-direction: column;
    gap: 10px;
    align-items: stretch;
  }
}
  .student-options-group {
      position: relative;
      display: inline-block;
    }

.student-options-btn {
  background: #fff;
  border: 2px solid #2299ee;
  color: #2299ee;
  font-size: 1.6rem;
  cursor: pointer;
  padding: 6px 13px;
  margin: 0;
  border-radius: 50%;
  transition: background 0.15s, color 0.15s, box-shadow 0.12s;
  box-shadow: 0 2px 8px #2299ee33;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  position: relative;
  z-index: 10;
}
.student-options-btn:hover,
.student-options-btn:focus {
  background: #eafaf5;
  color: #25a55f;
  border-color: #25a55f;
  box-shadow: 0 4px 14px #43a04722;
}

.user-dashboard-header {
  background: linear-gradient(90deg,#d1f2eb 0%, #b2f7ef 100%);
  padding: 28px 38px 18px 38px;
  border-radius: 18px;
  box-shadow: 0 4px 18px rgba(60, 100, 100, 0.11);
  margin-bottom: 26px;
  margin-top: 22px;
  max-width: 900px;
  margin-left: auto;
  margin-right: auto;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  flex-wrap: wrap;
}
.user-dashboard-info h2 {
  margin: 0 0 8px 0;
  font-weight: 700;
  color: #11695c;
  font-size: 1.5rem;
  display: flex;
  align-items: center;
  gap: 10px;
}
.user-dashboard-layout {
  display: flex;
  flex-direction: column;
  gap: 0; /* or keep a small gap if you want spacing */
  max-width: 1200px;
  margin: auto;
}

.user-dashboard-menu {
  display: flex;
  flex-direction: row;
  gap: 14px;
  min-width: 0;
  justify-content: center;
  width: 100%;
}
.user-dashboard-menu button {
  background: #f8faf9;
  border: none;
  color: #223046;
  font-family: inherit;
  font-size: 1rem;
  font-weight: 600;
  padding: 12px 24px;
  border-radius: 10px;
  cursor: pointer;
  box-shadow: 0 2px 8px #aacfc333;
  transition: background 0.16s, color 0.17s, box-shadow 0.12s, transform 0.12s;
  display: flex;
  align-items: center;
  gap: 12px;
  outline: none;
  text-align: left;
}
.user-dashboard-menu button:hover,
.user-dashboard-menu button.active {
  background: linear-gradient(90deg, #43a047 80%, #25a55f 100%);
  color: #fff;
  box-shadow: 0 4px 14px #43a04722;
  transform: scale(1.03);
}
.user-dashboard-main {
  flex: 1;
  background: #fff;
  border-radius: 18px;
  box-shadow: 0 4px 20px #aacfc322;
  padding: 38px 36px 26px 36px;
  min-width: 280px;
}
.userTabContent h3 {
  color: #18684b;
  font-size: 1.17rem;
  margin-top: 10;
  margin-bottom: 18px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.clock-btn {
  font-size: 1.12rem;
  padding: 12px 30px;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  margin-right: 18px;
  margin-bottom: 0;
  transition: background 0.13s, transform 0.13s;
  cursor: pointer;
}
.clock-btn:hover {
  filter: brightness(1.08);
  transform: scale(1.04);
}
.post-options-menu button:hover {
  background: #eafaf5;
  color: #25a55f;
}
#adminFaqsList form button:hover {
  background: linear-gradient(90deg, #2299ee, #43a047);
}

/* Add this to your <style> section for OJT table styling */
.ojt-admin-table {
  width: 100%;
  border-collapse: collapse;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 2px 18px #0001;
  margin-top: 28px;
  overflow: hidden;
}
.ojt-admin-table th, .ojt-admin-table td {
  padding: 16px 18px;
  text-align: left;
}
.ojt-admin-table th {
  background: linear-gradient(90deg, #43a047 50%, #25a55f 100%);
  color: #fff;
  font-size: 1.09em;
  font-weight: 700;
  border-bottom: 2px solid #b2dfdb;
}
.ojt-admin-table tr:not(:last-child) {
  border-bottom: 1.5px solid #eafaf5;
}
.ojt-progress-bg {
  background: #d3eede;
  border-radius: 6px;
  width: 100%;
  height: 12px;
  margin-top: 4px;
  margin-bottom: 0;
  overflow: hidden;
}
.ojt-progress {
  height: 100%;
  background: linear-gradient(90deg, #25a55f 80%, #2299ee 100%);
  border-radius: 6px;
}
.ojt-accomplished {
  color: #2299ee;
  font-weight: 700;
}
.ojt-remaining {
  color: #e67e22;
  font-weight: 700;
}

/* Admin Report Generator Styles */
.admin-report-card {
  background: #fff;
  border-radius: 26px;
  box-shadow: 0 4px 24px #0002;
  padding: 2.5em 2.2em 2em 2.2em;
  max-width: 500px;
  margin: 40px auto 0 auto;
  text-align: center;
}
.admin-report-card h2 {
  color: #222;
  font-size: 2em;
  font-weight: 700;
  margin-bottom: 1.3em;
  letter-spacing: 1px;
}
.admin-report-label {
  font-weight: 600;
  color: #444;
  margin-bottom: .4em;
  font-size: 1.08em;
  display: block;
  text-align: left;
}
.admin-report-select,
.admin-report-range {
  background: #8bb6a7;
  color: #fff;
  border: none;
  border-radius: 18px;
  padding: 1em 1.1em;
  font-size: 1.07em;
  margin-bottom: 1.2em;
  width: 100%;
  text-align: left;
  font-weight: 600;
  outline: none;
  cursor: pointer;
  transition: background 0.12s;
}
.admin-report-btn {
  width: 100%;
  padding: 1em 0;
  margin-bottom: 16px;
  background: linear-gradient(90deg, #101010 0%, #06331f 100%);
  color: #fff;
  border: none;
  border-radius: 16px;
  font-size: 1.12em;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 14px;
  cursor: pointer;
  transition: background 0.15s, transform 0.12s;
}
.admin-report-btn:last-child { margin-bottom: 0; }
.admin-report-btn:hover { background: linear-gradient(90deg, #074724, #101010); transform: scale(1.03);}
.admin-report-desc {
  margin-top: 1.6em;
  background: #f8fbfd;
  color: #477;
  padding: 1.2em;
  border-radius: 12px;
  font-size: 1.06em;
  font-weight: 500;
}

.student-list-scroll-container {
  max-height: 420px;
  overflow-y: auto;
  background: transparent;
  border-radius: 22px;
  margin: 0 auto;
  box-shadow: none;
  padding-bottom: 80px; /* Extra space for menu */
}
.ojt-admin-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  background: transparent;
  border-radius: 22px;
  box-shadow: 0 2px 18px #0001;
  margin: 0;
}

.ojt-admin-table th {
  background: #f4fffb;
  color: #222;
  font-size: 1.10em;
  font-weight: 700;
  border-bottom: 2px solid #b2dfdb;
  padding: 18px 0;
  text-align: left;
}

.ojt-admin-table td {
  padding: 18px 0 18px 0;
  font-size: 1.09em;
  text-align: left;
}

.ojt-admin-table tr {
  background: rgba(60, 100, 100, 0.14);
  border-bottom: 1px solid #b2dfdb;
  transition: background 0.18s;
}

.ojt-admin-table tr:last-child {
  border-bottom: none;
}

.ojt-admin-table tr:hover {
  background: #eafaf5;
}

/* Rounded corners on first/last row */
.ojt-admin-table tr:first-child th:first-child { border-top-left-radius: 22px; }
.ojt-admin-table tr:first-child th:last-child { border-top-right-radius: 22px; }
.ojt-admin-table tr:last-child td:first-child { border-bottom-left-radius: 22px; }
.ojt-admin-table tr:last-child td:last-child { border-bottom-right-radius: 22px; }

.student-options-menu {
  display: none;
  position: absolute;
  right: 0;
  background: #fff;
  min-width: 170px;
  border-radius: 14px;
  box-shadow: 0 8px 24px #25a55f44;
  z-index: 99999;
  padding: 12px 0;
  text-align: left;
  overflow: visible;
  transition: top 0.15s, bottom 0.15s;
}
.student-options-menu.show {
  display: block;
}

.student-options-menu button {
  display: flex;
  align-items: center;
  gap: 11px;
  width: 100%;
  background: none;
  border: none;
  padding: 11px 24px;
  text-align: left;
  font-size: 1.07em;
  color: #223046;
  cursor: pointer;
  transition: background 0.13s, color 0.13s;
}

.student-options-menu button:hover {
  background: #eafaf5;
  color: #25a55f;
}

.student-options-menu button:last-child {
  color: #e74c3c !important;
  font-weight: 700;
}

.requirements-card {
  background: #fff;
  border-radius: 15px;
  box-shadow: 0 4px 16px #0002;
  padding: 2em 1.6em 2em 1.6em;
  margin: 100px auto 0 auto;
  max-width: 1400px;
  min-width: 340px;
}

.requirements-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  background: transparent;
  border-radius: 12px;
  box-shadow: 0 2px 12px #25a55f11;
  overflow-x: auto;
}

.requirements-table th {
  background: linear-gradient(90deg, #eafaf5 70%, #b2dfdb 100%);
  color: #223046;
  font-size: 1.06em;
  font-weight: 700;
  padding: 18px 12px;
  text-align: left;
  border-bottom: 2px solid #b2dfdb;
  position: sticky;
  top: 0;
  z-index: 2;
  white-space: normal;
}

.requirements-table td {
  padding: 16px 12px;
  font-size: 1em;
  border-bottom: 1px solid #eafaf5;
  vertical-align: middle;
}

.requirements-table tr {
  background: #fff;
  transition: background 0.15s;
}

.requirements-table tr:nth-child(even) {
  background: #f7fcfa;
}

.requirements-table tr:hover {
  background: #eafaf5;
}

.requirements-file-link {
  color: #2299ee;
  text-decoration: none;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.requirements-file-link i {
  font-size: 1.05em;
  color: #25a55f;
}

.requirements-table th, .requirements-table td {
  min-width: 110px;
  word-break: break-word;
}

@media (max-width: 900px) {
  .requirements-card {
    padding: 1em .5em;
    max-width: 99vw;
  }
  .requirements-table th, .requirements-table td {
    font-size: .93em;
    min-width: 70px;
    padding: 10px 4px;
  }
}

.student-options-group {
  position: relative;
  display: inline-block;
}


.banner-with-logo {
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(90deg, #00695c, #43a047);
  color: #fff;
  font-size: 2.2rem;
  font-weight: bold;
  padding: 20px 50px;
  border-radius: 0px;
  margin-bottom: 60px;
  box-shadow: 0 4px 22px rgba(0,0,0,0.13);
  text-align: center;
  letter-spacing: 1px;
  gap: 28px;
}
.banner-logo {
  width: 80px;
  height: 80px;
  border-radius: 12px;
  box-shadow: 0 2px 8px #0002;
  object-fit: contain;
}
/* Requirements upload - pleasant design */
.requirements-form-row {
  display: flex;
  align-items: center;
  margin-bottom: 1.3em;
  gap: 22px;
}

.requirements-label {
  flex: 0 0 270px;
  font-weight: bold;
  color: #18684b;
  font-size: 1.08em;
}

.requirements-checkbox {
  margin-right: 12px;
  accent-color: #43a047;
  transform: scale(1.2);
}

.requirements-file-input {
  flex: 1 1 220px;
  max-width: 220px;
  padding: 8px 18px;
  border-radius: 13px;
  border: 1.5px solid #b2dfdb;
  font-size: 1em;
  background: #eafaf5;
  color: #222;
  cursor: pointer;
  transition: border-color 0.16s;
}

.requirements-file-input:focus {
  border-color: #43a047;
  outline: none;
}
.ojt-admin-table td:last-child {
  position: relative;
  min-width: 60px;
  z-index: 2;
}
#editClassModal {
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: #0006;
  z-index: 999;
  display: none;      /* For centering */
  align-items: center;
  justify-content: center;
}

  /* Ensure clean page breaks in PDF rendering */
  * {
    box-sizing: border-box;
  }

  .page-break,
  [data-page-break],
  section,
  article,
  .report-section {
    page-break-inside: avoid !important;
    break-inside: avoid !important;
    page-break-before: auto;
    break-before: auto;
    page-break-after: auto;
    break-after: auto;
  }

  /* Force a page break before large new sections if needed */
  h1, h2, h3 {
    page-break-before: always;
    break-before: page;
  }

  /* Avoid isolated headings at bottom of page */
  h1, h2, h3, h4 {
    page-break-after: avoid;
    break-after: avoid;
  }
.menu-btn {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 1.5em;
  color: #2299ee;
  padding: 0 7px;
  transition: color 0.15s;
}
.menu-btn:hover {
  color: #1565c0;
}
.comment-menu {
  display: none;
  position: absolute;
  right: 0;
  top: 28px;
  min-width: 75px;
  background: #fff;
  border: 1px solid #e0e0e0;
  box-shadow: 0 2px 10px #0003;
  border-radius: 8px;
  z-index: 1000;
}
.comment-menu div {
  padding: 8px 15px;
  cursor: pointer;
  font-size: 0.97em;
  user-select: none;
}
.comment-menu div:hover {
  background: #f0f5ff;
}
.comment-menu div:last-child {
  color: #e74c3c;
  border-bottom: none;
}
.menu-btn {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 1.5em;
  color: #2299ee;
  padding: 0 7px;
  transition: color 0.15s;
}
.menu-btn:hover {
  color: #1565c0;
}
.comment-menu {
  display: none;
  position: absolute;
  right: 0;
  top: 28px;
  min-width: 75px;
  background: #fff;
  border: 1px solid #e0e0e0;
  box-shadow: 0 2px 10px #0003;
  border-radius: 8px;
  z-index: 1000;
}
.comment-menu div {
  padding: 8px 15px;
  cursor: pointer;
  font-size: 0.97em;
  user-select: none;
}
.comment-menu div:hover {
  background: #f0f5ff;
}
.comment-menu div:last-child {
  color: #e74c3c;
  border-bottom: none;
}
.menu-btn {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 1.5em;
  color: #2299ee;
  padding: 0 7px;
  transition: color 0.15s;
}
.menu-btn:hover {
  color: #1565c0;
}
.comment-menu {
  display: none;
  position: absolute;
  right: 0;
  top: 28px;
  min-width: 75px;
  background: #fff;
  border: 1px solid #e0e0e0;
  box-shadow: 0 2px 10px #0003;
  border-radius: 8px;
  z-index: 1000;
}
.comment-menu div {
  padding: 8px 15px;
  cursor: pointer;
  font-size: 0.97em;
  user-select: none;
}
.comment-menu div:hover {
  background: #f0f5ff;
}
.comment-menu div:last-child {
  color: #e74c3c;
  border-bottom: none;
}
.menu-btn {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 1.5em;
  color: #2299ee;
  padding: 0 7px;
  transition: color 0.15s;
}
.menu-btn:hover {
  color: #1565c0;
}
.comment-menu {
  display: none;
  position: absolute;
  right: 0;
  top: 28px;
  min-width: 90px;
  background: #fff;
  border: 1px solid #e0e0e0;
  box-shadow: 0 2px 10px #0003;
  border-radius: 8px;
  z-index: 1000;
}
.comment-menu div {
  padding: 10px 18px;
  cursor: pointer;
  font-size: 1.01em;
  user-select: none;
}
.comment-menu div:hover {
  background: #f0f5ff;
}
.comment-menu div:last-child {
  color: #e74c3c;
  border-bottom: none;
}
.menu-btn {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 1.5em;
  color: #2299ee;
  padding: 0 7px;
  transition: color 0.15s;
}
.menu-btn:hover {
  color: #1565c0;
}
.comment-menu {
  display: none;
  position: absolute;
  right: 0;
  top: 28px;
  min-width: 90px;
  background: #fff;
  border: 1px solid #e0e0e0;
  box-shadow: 0 2px 10px #0003;
  border-radius: 8px;
  z-index: 1000;
}
.comment-menu div {
  padding: 10px 18px;
  cursor: pointer;
  font-size: 1.01em;
  user-select: none;
}
.comment-menu div:hover {
  background: #f0f5ff;
}
.comment-menu div:last-child {
  color: #e74c3c;
  border-bottom: none;
}
.requirements-card {
  background: #fff;
  border-radius: 20px;
  box-shadow: 0 4px 20px rgba(67,160,71,0.15);
  padding: 2em;
  margin: 2em 0;
  font-family: 'Segoe UI', Arial, sans-serif;
}

.requirements-table {
  border-collapse: separate;
  border-spacing: 0;
  width: 100%;
  font-size: 15px;
  background: #f5fbf7;
}

/* General header and cell settings */
.requirements-table th, .requirements-table td {
  padding: 0.7em 0.5em;
  text-align: center;
  font-size: 1em;
  white-space: nowrap;
  word-break: keep-all;
}

.requirements-table th {
  background: linear-gradient(90deg, #43a047 75%, #a5d6a7 100%);
  color: #fff;
  font-weight: 700;
  letter-spacing: 0.04em;
  border-bottom: 3px solid #eafaf5;
}

/* Only adjust name column */
.requirements-table th:nth-child(2),
.requirements-table td:nth-child(2) {
  min-width: 230px;
  max-width: 430px;
  text-align: left;
  white-space: normal;
  word-break: break-word;
  font-weight: 600;
  font-size: 1.07em;
}


/* Other columns: narrower */
.requirements-table th:not(:nth-child(2)),
.requirements-table td:not(:nth-child(2)) {
  min-width: 80px;
  max-width: 130px;
}

/* School ID font style */
.requirements-table td:first-child {
  color: #2299ee;
  font-weight: 700;
}

/* Requirement link style, wraps if needed */
.requirements-table td a {
  color: #2299ee;
  text-decoration: underline;
  font-weight: 600;
  word-break: break-word;
  white-space: normal;
}

/* Table row styling */
.requirements-table td {
  background: #fff;
  border-bottom: 1px solid #eafaf5;
  transition: background 0.18s;
}

.requirements-table tr:nth-child(even) td {
  background: #eafaf5;
}

.requirements-table tr:hover td {
  background: #d0f5e3 !important;
}

/* Responsive adjustments */
@media (max-width: 1100px) {
  .requirements-table th, .requirements-table td {
    min-width: 65px;
    font-size: 0.95em;
    padding: 0.6em 0.3em;
  }
  .requirements-table th:nth-child(2),
  .requirements-table td:nth-child(2) {
    min-width: 120px;
    max-width: 200px;
    font-size: 1em;
  }
  .requirements-card {
    padding: 1em;
  }
}

.requirements-card h2 {
  font-size: 1.5em;
  margin-bottom: 1em;
  display: flex;
  align-items: center;
  gap: 8px;
}

.requirements-card h2 i {
  font-size: 1.4em;
  color: #43a047;
}

  </style>
</head>
<body>
  <div class="banner-with-logo">
  <img src="slsu-logo.png" alt="SLSU Logo" class="banner-logo">
  <span>Southern Luzon State University Catanauan Internship Monitoring System</span>
</div>


  <div class="btn-group" id="roleSelect">
    <button class="select-btn" onclick="showLogin('admin')">Admin</button>
    <button class="select-btn" onclick="showLogin('user')">User</button>
  </div>

   <!-- Admin Login Form -->
  <form class="login-form" id="adminLoginForm" onsubmit="adminLogin(event)">
    <h2>Admin Login</h2>
    <input type="email" id="adminEmail" placeholder="Email" required>
    <div style="position:relative;">
  <input type="password" id="adminPassword" placeholder="Password" required style="padding-right:12px;">
  <span id="toggleAdminPassword" onclick="toggleAdminPassword()" style="
    position:absolute; 
    top:50%; 
    right:12px; 
    transform:translateY(-50%);
    cursor:pointer;
    color:#888;
    font-size:1.1rem;
  ">
    <i class="fas fa-eye" id="adminEye"></i>
  </span>
</div>
    <button type="button" class="form-btn" onclick="showAdminForgotPassword()"><i class="fas fa-key"></i> Forgot Password?</button>
    <button type="submit" class="form-btn"><i class="fas fa-sign-in-alt"></i>Login</button>
    <button type="button" class="create-btn" onclick="showCreateAdmin()"><i class="fas fa-user-plus"></i>Create Account</button>
    <button type="button" class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i>Back</button>
  </form>
 <div class="login-form" id="adminForgotPasswordForm" style="display:none;">
  <h2>Admin Password Recovery</h2>
  <input type="email" id="forgotAdminEmail" placeholder="Enter your admin email" required>
  <button type="button" class="form-btn" onclick="sendAdminPasswordReset()">Send Reset Link</button>
  <button type="button" class="back-btn" onclick="hideAdminForgotPassword()"><i class="fas fa-arrow-left"></i> Back</button>
  <div id="forgotAdminMessage" style="margin-top:14px;color:#2299ee;"></div>
</div>

  <!-- User Login Form -->
  <form class="login-form" id="userLoginForm" onsubmit="userLogin(event)">
    <h2>Student Login</h2>
    <input type="text" id="userID" placeholder="School ID" required>
    <div style="position:relative;">
  <input type="password" id="userPassword" placeholder="Password" required style="padding-right:12px;">
  <span id="toggleUserPassword" onclick="toggleUserPassword()" style="
    position:absolute;
    top:50%;
    right:12px;
    transform:translateY(-50%);
    cursor:pointer;
    color:#7bb292;
    font-size:1.13rem;
  ">
    <i class="fas fa-eye" id="userEye"></i>
  </span>
</div>
    <button type="submit" class="form-btn"><i class="fas fa-sign-in-alt"></i>Login</button>
    <button type="button" class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i>Back</button>
  </form>

  <!-- Create Admin Form (hidden initially) -->
  <form class="login-form" id="createAdminForm" style="display:none;" onsubmit="createAdmin(event)">
  <h2>Create Admin Account</h2>
  <input type="text" id="newAdminName" placeholder="Full Name" required>
  <input type="email" id="newAdminEmail" placeholder="Institutional Email" required>
  <div style="position:relative;">
    <input type="password" id="newAdminPass" placeholder="Password" required style="padding-right:12px;">
    <span id="toggleNewAdminPassword" onclick="toggleNewAdminPassword()" style="
      position:absolute; 
      top:50%; 
      right:12px; 
      transform:translateY(-50%);
      cursor:pointer;
      color:#888;
      font-size:1.1rem;
    ">
      <i class="fas fa-eye" id="newAdminEye"></i>
    </span>
  </div>
  <select id="newAdminDept" required style="width:94%;padding:14px;margin:10px 0;border-radius:10px;border:1.5px solid #b2dfdb;font-size:1rem;background:#f1f8e9;">
    <!-- Departments will be loaded dynamically -->
  </select>
  <button type="button" class="form-btn" style="background:#eee;color:#00695c;margin-bottom:10px;" onclick="openDeptManager()">
    <i class="fas fa-edit"></i> Manage Departments 
  </button>
  <input type="text" id="newAdminSecCode" placeholder="Faculty Security Code" required>
  <input type="text" id="facultyCode" placeholder="Enter OTP" required />
  <button type="button" onclick="sendOTP()">Send OTP</button>
  <button type="submit" class="create-btn"><i class="fas fa-user-plus"></i>Create Account</button>
  <button type="button" class="back-btn" onclick="goBackToAdminLogin()"><i class="fas fa-arrow-left"></i>Back</button>
</form>

<div id="deptManagerModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:#0004;z-index:99;align-items:center;justify-content:center;">
  <div class="dept-modal-card">
    <h3 class="dept-modal-title"><i class="fas fa-building"></i> Manage Departments</h3>
    <div class="dept-section">
      <b style="color:#2495e6;">Departments:</b>
      <ul id="deptList" class="dept-list"></ul>
      <div class="dept-add-group">
        <input type="text" id="deptInput" placeholder="Add Department" class="dept-input">
        <button type="button" class="dept-btn-add" onclick="addDepartment()">
          <i class="fas fa-plus"></i> Add
        </button>
      </div>
    </div>
    <button type="button" class="dept-btn-done" onclick="closeDeptManager()">
      <i class="fas fa-arrow-left"></i> Done
    </button>
  </div>
</div>

<div class="class-management" id="classManagementSection">
    <h2>Class Management</h2>
    <form onsubmit="addClass(event)">
      <input type="text" id="courseInput" placeholder="Course" required>
      <input type="text" id="sectionInput" placeholder="Section" required>
      <input type="number" id="hoursInput" placeholder="OJT Hours" required min="1">
      <button type="submit" class="form-btn"><i class="fas fa-plus"></i> Add Class</button>
      <button type="button" class="back-btn" onclick="backToAdminLogin()">
  <i class="fas fa-arrow-left"></i> Back
</button>

<div id="classCollaboratorsPanel" style="display:block; margin:24px auto; max-width:600px;">
  <div style="background:#f8faf8;border-radius:16px;box-shadow:0 2px 12px #43a04722;padding:2em;">
    <h3 style="color:#2299ee;display:flex;align-items:center;gap:8px;">
      <i class="fas fa-users"></i> Collaborators
    </h3>
    <!-- Class selection dropdown -->
    <div style="margin-bottom:1em;">
      <label for="collabClassSelect" style="font-weight:600;">Select Class:</label>
      <select id="collabClassSelect" style="padding:7px 12px;border-radius:7px;border:1px solid #b2dfdb;"></select>
    </div>
    <!-- Collaborators list -->
    <ul id="collaboratorsList" style="margin-bottom:1em;"></ul>
    <!-- Add Collaborator Form -->
    <div id="addCollaboratorForm" style="display:flex;gap:8px;">
      <input type="email" id="collabEmailInput" placeholder="Admin email to add" style="flex:1;padding:8px;border-radius:8px;border:1.5px solid #b2dfdb;">
      <select id="collabRoleInput" style="padding:8px;border-radius:8px;border:1.5px solid #b2dfdb;">
        <option value="viewer">Viewer</option>
        <option value="editor">Editor</option>
      </select>
      <button type="button" onclick="addCollaborator()" style="background:#43a047;color:#fff;border:none;border-radius:8px;padding:8px 16px;font-weight:600;">
        <i class="fas fa-user-plus"></i> Add
      </button>
    </div>
    <div id="collabMsg" style="margin-top:1em;color:#e74c3c;"></div>
  </div>
</div>


    </form>
    <div class="class-list" id="classList">
      <!-- List of created classes will show here -->
    </div>
  </div>

<div id="editClassModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:#0006;z-index:999;align-items:center;justify-content:center;">
  <div style="background:#fff;padding:32px 24px 16px 24px;border-radius:16px;min-width:320px;box-shadow:0 8px 32px #0002;text-align:left;position:relative;">
    <h2>Edit Class</h2>
    <label>Class Name: <input type="text" id="editClassName"></label><br>
    <label>Section: <input type="text" id="editClassSection"></label><br>
    <label>OJT Hours: <input type="number" id="editClassHours"></label><br>
    <button onclick="saveClassEdits()">Save</button>
    <button onclick="clearEditClassModal()">Cancel</button>
    <span onclick="clearEditClassModal()" style="position:absolute;top:10px;right:16px;cursor:pointer;font-size:1.3rem;color:#aaa;">&times;</span>
  </div>
</div>


  <!-- Admin Dashboard -->
<div class="dashboard" id="adminDashboard" style="display:none;">
  <div class="dashboard-header">
    <span id="dashboardClassName"></span>
  </div>
  <div class="dashboard-nav">
  <button class="dashboard-nav-btn tab-btn" id="tabEnroll" onclick="showTab('enroll')"><i class="fas fa-user-plus"></i> Enroll Students</button>
  <button class="dashboard-nav-btn tab-btn" id="tabList" onclick="showTab('list')"><i class="fas fa-users"></i> Students List</button>
  <button class="dashboard-nav-btn tab-btn" id="tabActivities" onclick="showTab('activities')"><i class="fas fa-calendar-check"></i> Activities</button>
  <button class="dashboard-nav-btn tab-btn" id="tabRequirements" onclick="showTab('requirements')"><i class="fas fa-file-alt"></i> Requirements</button>
  <button class="dashboard-nav-btn tab-btn" id="tabFaqs" onclick="showTab('faqs')"><i class="fas fa-question-circle"></i> FAQs</button>
  <button class="dashboard-nav-btn tab-btn" id="tabojt" onclick="showTab('ojt')"><i class="fas fa-clock"></i> OJT Hours</button>
  <button class="dashboard-nav-btn tab-btn" id="tabReports" onclick="showTab('reports')"><i class="fas fa-chart-line"></i> Reports</button>
  <button class="dashboard-nav-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
  <button class="dashboard-nav-btn tab-btn" id="tabSettings" onclick="showTab('settings')"><i class="fas fa-cog"></i> Settings</button>
</div>
    <div id="tab-enroll" style="display:none;">
    <div class="enroll-student-container">
    <h2 class="enroll-header"><i class="fas fa-user-plus"></i> Enroll Student</h2>
    <form id="enrollStudentForm" onsubmit="enrollStudent(event)">
    <div class="enroll-row">
      <input type="text" id="studLast" placeholder="Last Name" required>
      <input type="text" id="studFirst" placeholder="First Name" required>
    </div>
    <div class="enroll-row">
      <input type="text" id="studMiddle" placeholder="Middle Name" required>
      <input type="text" id="studExt" placeholder="Extension (e.g. Jr.)">
    </div>
    <div class="enroll-row">
      <label for="studDept" style="font-weight:500;"></label>
    <select id="studDept" required>
    <option value="" disabled selected>Select Department</option>
</select>
      <input type="text" id="studID" placeholder="School ID" required>
      <input type="email" id="studEmail" placeholder="Email" required>
      <input type="password" id="studPass" placeholder="Password" required>
    </div>
    <div class="enroll-actions">
      <button type="submit" class="enroll-btn"><i class="fas fa-plus"></i> Enroll Student</button>
      <label for="excelUpload" class="excel-label">
        <i class="fas fa-file-excel"></i> Enlist via Excel
      </label>
      <input type="file" id="excelUpload" style="display:none;" accept=".xlsx,.xls" onchange="excelStudentUpload(event)">
    </div>
  </form>
</div>
    </div>

<div id="tab-list" style="display:none;">
  <div class="student-list-scroll-container" id="studentTableScroll"></div>
</div>

    <div id="tab-activities" style="display:none;">
  <h2 class="enroll-header"><i class="fas fa-calendar-check"></i> Activities</h2>
  <div id="adminActivitiesLogs"></div>
</div>

   <div id="tab-requirements" style="display:none;">
  <h2 class="enroll-header"><i class="fas fa-file-alt"></i> Requirements</h2>
  <div id="adminRequirementsTable"></div>
</div>

<div id="tab-faqs" style="display:none;">
  <h2 class="enroll-header"><i class="fas fa-question-circle"></i> FAQs</h2>
  <div id="adminFaqsList"></div>
</div>

    <div id="tab-ojt" style="display:none;">OJT hours overview here.</div>

<div id="tab-reports" style="display:none;">
  <div class="admin-report-card" id="adminReportCard">
    <h2>Generate Reports</h2>
    <div>
      <label class="admin-report-label" for="adminReportStudent">Select Student:</label>
      <select id="adminReportStudent" class="admin-report-select"></select>
    </div>
    <div>
      <label class="admin-report-label" for="adminReportRange">Select Report Range:</label>
      <select id="adminReportRange" class="admin-report-range">
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
        <option value="all">All Records</option>
      </select>
    </div>
    <div style="margin:1em 0;text-align:left;">
      <label><input type="checkbox" id="includeLogs" checked> Include Daily Logs</label><br>
      <label><input type="checkbox" id="includeFaqs" checked> Include FAQs</label>
    </div>
    <button class="admin-report-btn" onclick="generateAdminReport()"><i class="fas fa-file-alt"></i> Generate</button>
    <button class="admin-report-btn" onclick="exportAdminReportPDF()"><i class="fas fa-file-pdf"></i> Export PDF</button>
    <button class="admin-report-btn" onclick="exportAdminReportDOCX()"><i class="fas fa-file-word"></i> Export DOCX</button>
    <div class="admin-report-desc">
      Select a student, range and what to include, then click generate.
    </div>
    <div id="adminReportResult" style="margin-top:2em;"></div>
  </div>
</div>

   <div id="tab-settings" style="display:none;">
  <div class="settings-card" style="max-width:480px;margin:2em auto;padding:2em;background:#fff;border-radius:18px;box-shadow:0 2px 14px #0002;">
    <h2 style="margin-bottom:1.3em;">Admin Settings</h2>
    <button onclick="resetSystemData()" class="form-btn" style="width:100%;background:#e74c3c;margin-bottom:2em;">Reset All Data</button>
    <button onclick="deleteAdminAccount()" class="form-btn" style="width:100%;background:#c62828;margin-top:8px;">
  Delete My Admin Account
</button>
    <div>
      <label style="font-weight:600;display:block;margin-bottom:.7em;">View Student Logs Per Week</label>
      <select id="logsStudentSelect" style="width:100%;padding:.8em;border-radius:7px;margin-bottom:1em;"></select>
      <button onclick="showStudentWeeklyLogs()" class="form-btn" style="width:100%;">Show Weekly Logs</button>
      <div id="weeklyLogsResult" style="margin-top:1.3em;"></div>
    </div>
  </div>
</div>
</div>

<div id="editStudentModal" style="
  display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;
  background:#0006;z-index:999;align-items:center;justify-content:center;">
  <div style="
    background:#fff;padding:32px 24px 16px 24px;border-radius:16px;
    min-width:320px;box-shadow:0 8px 32px #0002;text-align:left;position:relative;">
    <h3 style="margin-top:0;color:#25a55f;">Edit Student</h3>
    <form id="editStudentForm">
      <input type="hidden" id="editStudIdx">
      <div style="margin-bottom:8px;">
        <input id="editStudLast" placeholder="Last Name" required style="width:90%;padding:8px;">
      </div>
      <div style="margin-bottom:8px;">
        <input id="editStudFirst" placeholder="First Name" required style="width:90%;padding:8px;">
      </div>
      <div style="margin-bottom:8px;">
        <input id="editStudMiddle" placeholder="Middle Name" required style="width:90%;padding:8px;">
      </div>
      <div style="margin-bottom:8px;">
        <input id="editStudExt" placeholder="Extension (e.g. Jr.)" style="width:90%;padding:8px;">
      </div>
      <div style="margin-bottom:8px;">
        <input id="editStudDept" placeholder="Department" required style="width:90%;padding:8px;">
      </div>
      <div style="margin-bottom:8px;">
        <input id="editStudID" placeholder="School ID" required style="width:90%;padding:8px;">
      </div>
      <div style="margin-bottom:8px;">
        <input id="editStudEmail" placeholder="Email" required style="width:90%;padding:8px;">
      </div>
      <div style="margin-bottom:8px;">
        <input id="editStudPass" placeholder="Password" required style="width:90%;padding:8px;">
      </div>
      <div style="margin-top:12px;display:flex;gap:10px;justify-content:right;">
        <button type="button" onclick="closeEditStudentModal()" style="padding:8px 18px;border-radius:7px;background:#eee;color:#333;border:none;cursor:pointer;">Cancel</button>
        <button type="submit" style="padding:8px 18px;border-radius:7px;background:#25a55f;color:#fff;border:none;cursor:pointer;">Save</button>
      </div>
    </form>
    <span onclick="closeEditStudentModal()" style="position:absolute;top:10px;right:16px;cursor:pointer;font-size:1.3rem;color:#aaa;">&times;</span>
  </div>
</div>

<div id="userDashboard" style="display:none;">
  <div class="user-dashboard-header">
    <div class="user-dashboard-info">
      <h2><i class="fas fa-user-graduate"></i> Welcome, <span id="userName"></span></h2>
      <div style="font-size:1.05rem;color:#117969;margin-top:8px;">
        <span>Department: <b id="userDept"></b></span> &nbsp;|&nbsp;
        <span>OJT Required: <b id="userOjtTotal"></b> hrs</span> &nbsp;|&nbsp;
        <span>Status: <b id="userTimedInStatus" style="color:#e67e22;">-</b></span>
      </div>
    </div>
    <div class="user-dashboard-clock">
      <span id="userCurrentTime" style="font-size:1.2rem;font-weight:600;"></span>
    </div>
  </div>
  <div class="user-dashboard-layout">
    <nav class="user-dashboard-menu">
      <button onclick="showUserTab('clock')" id="userTabClock"><i class="far fa-clock"></i> Clock In/Out</button>
      <button onclick="showUserTab('logs')" id="userTabLogs"><i class="fas fa-book"></i> Daily Logs</button>
      <button onclick="showUserTab('ojt')" id="userTabOjt"><i class="fas fa-calendar"></i> OJT HOURS</button>
      <button onclick="showUserTab('requirements')" id="userTabRequirements"><i class="fas fa-check-square"></i> Requirements</button>
      <button onclick="showUserTab('faqs')" id="userTabFaqs"><i class="fas fa-question-circle"></i> FAQs</button>
      <button onclick="showUserTab('reports')" id="userTabReports"><i class="fas fa-chart-bar"></i> Reports</button>
      <button onclick="showUserTab('settings')" id="userTabSettings"><i class="fas fa-cog"></i> Settings</button>
      <button onclick="userLogout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </nav>
    <main class="user-dashboard-main">
      <section id="userTabContent-clock" class="userTabContent">
        <!-- Clock In/Out Content -->
        <h3><i class="far fa-clock"></i> Clock In/Out</h3>
        <div id="clockInOutSection">
          <div style="margin-bottom:18px;">
            <span>Status: <b id="userTimedInStatus2" style="color:#e67e22;">-</b></span>
          </div>
          <button id="clockInBtn" onclick="startClockInProcess()" class="clock-btn" style="background:#25a55f;color:#fff;"><i class="fas fa-sign-in-alt"></i> Clock In</button>
          <button id="clockOutBtn" onclick="clockOut()" class="clock-btn" style="background:#e74c3c;color:#fff;display:none;"><i class="fas fa-sign-out-alt"></i> Clock Out</button>
          <div id="clockMessage" style="margin-top:18px;"></div>
          <div id="lastRecord" style="margin-top:20px;color:#18684b;font-size:1.07rem;"></div>
          <div id="webcamSection" style="display:none; margin-bottom:15px;">
  <video id="webcamVideo" autoplay playsinline width="320" height="240" style="border-radius:8px; border:1.5px solid #b2dfdb;"></video>
  <br>
  <button onclick="capturePhoto()" style="margin-top:8px; background:#25a55f;color:#fff; border:none; border-radius:8px; padding:8px 18px; font-size:1rem; font-weight:600;">Capture Photo</button>
</div>
<canvas id="webcamCanvas" width="320" height="240" style="display:none;"></canvas>
<img id="capturedPhoto" style="display:none; margin:10px 0; border-radius:8px; border:1.5px solid #b2dfdb; width:320px; height:240px;" />
        </div>
    <div id="clockRecords"></div>
      </section>

      <section id="userTabContent-logs" class="userTabContent" style="display:none;">
        <h3><i class="fas fa-book"></i> Daily Logs</h3>
        <div id="userDailyLogs"></div>
        <!-- Daily Log Form START -->
        <div id="dailyLogContainer" style="background:#fff;border-radius:2em;padding:2em;max-width:480px;margin:32px auto 0;box-shadow:0 2px 18px #0002;">
          <hr style="width:60px;margin:0 auto 1.2em auto;border:0.5px solid #ddd;">
          <h2 style="text-align:center;font-weight:700;color:#222;margin-bottom:1.5em;">Daily Logs / Activities</h2>
          <form id="dailyLogForm" autocomplete="off">
            <input 
              type="text" 
              id="logTitle" 
              placeholder="Post something..." 
              style="width:100%;padding:1em;margin-bottom:1em;background:#8bb6a7;border:none;border-radius:1em;font-size:1.1em;color:#fff;font-weight:500;outline:none;"
              required
            >
            <label style="display:block;text-align:center;color:#222;font-weight:500;font-size:1.1em;margin-bottom:0.7em;">
              Describe the activity
            </label>
            <textarea 
              id="logDesc" 
              placeholder="Write your activity here..." 
              rows="4" 
              style="width:100%;padding:1em;background:#8bb6a7;border:none;border-radius:1em;font-size:1em;color:#fff;outline:none;margin-bottom:1.3em;"
              required
            ></textarea>
            <label style="display:block;font-size:1em;color:#222;margin-bottom:0.4em;">
              Upload an image <span style="color:#e74c3c;">(required)</span>
            </label>
            <input 
              type="file" 
              id="logImg" 
              accept="image/*" 
              style="margin-bottom:1.2em;" 
              required
            >
            <button 
              type="submit" 
              style="width:100%;padding:0.9em 0;font-size:1.2em;font-weight:700;border:none;border-radius:1em;background:linear-gradient(90deg,#101010,#2299ee);color:#fff;cursor:pointer;">
              Add
            </button>
          </form>
          <div id="dailyLogsList" style="margin-top:2em;"></div>
        </div>
        <!-- Daily Log Form END -->
      </section>

     <section id="userTabContent-requirements" class="userTabContent" style="display:none;">
  
<div id="requirementsUploadContainer" style="background:#fff;border-radius:2em;padding:2.5em;max-width:480px;margin:48px auto 0;box-shadow:0 2px 18px #0002;">
  <hr style="width:60px;margin:0 auto 1.4em auto;border:0.5px solid #ddd;">
  <h2 style="text-align:center;font-weight:700;color:#4b6a5c;margin-bottom:1.8em;">Upload Requirements</h2>
  <form id="requirementsForm" autocomplete="off">
  <div class="requirements-form-row">
    <input type="checkbox" id="chkResume" class="requirements-checkbox" readonly>
    <label for="reqResume" class="requirements-label">Resume</label>
    <input type="file" name="resume" id="reqResume" class="requirements-file-input">
  </div>
  <div class="requirements-form-row">
    <input type="checkbox" id="chkEndorsement" class="requirements-checkbox" readonly>
    <label for="reqEndorsement" class="requirements-label">Endorsement Letter</label>
    <input type="file" name="endorsement" id="reqEndorsement" class="requirements-file-input">
  </div>
  <div class="requirements-form-row">
    <input type="checkbox" id="chkIdpic" class="requirements-checkbox" readonly>
    <label for="reqIdpic" class="requirements-label">2x2 ID Picture</label>
    <input type="file" name="idpic" id="reqIdpic" class="requirements-file-input">
  </div>
  <div class="requirements-form-row">
    <input type="checkbox" id="chkMedical" class="requirements-checkbox" readonly>
    <label for="reqMedical" class="requirements-label">Medical Certificate</label>
    <input type="file" name="medical" id="reqMedical" class="requirements-file-input">
  </div>
  <div class="requirements-form-row">
    <input type="checkbox" id="chkWaiver" class="requirements-checkbox" readonly>
    <label for="reqWaiver" class="requirements-label">Waiver</label>
    <input type="file" name="waiver" id="reqWaiver" class="requirements-file-input">
  </div>
  <div class="requirements-form-row">
    <input type="checkbox" id="chkInternApp" class="requirements-checkbox" readonly>
    <label for="reqInternApp" class="requirements-label">STUDENT INTERNS Application Form</label>
    <input type="file" name="internApp" id="reqInternApp" class="requirements-file-input">
  </div>
  <div class="requirements-form-row">
    <input type="checkbox" id="chkContract" class="requirements-checkbox" readonly>
    <label for="reqContract" class="requirements-label">INTERNSHIP CONTRACT/AGREEMENT</label>
    <input type="file" name="contract" id="reqContract" class="requirements-file-input">
  </div>
  <div class="requirements-form-row">
    <input type="checkbox" id="chkAcceptance" class="requirements-checkbox" readonly>
    <label for="reqAcceptance" class="requirements-label">INTERNSHIP ACCEPTANCE LETTER</label>
    <input type="file" name="acceptance" id="reqAcceptance" class="requirements-file-input">
  </div>
  <div class="requirements-form-row">
    <input type="checkbox" id="chkInsurance" class="requirements-checkbox" readonly>
    <label for="reqInsurance" class="requirements-label">INSURANCE</label>
    <input type="file" name="insurance" id="reqInsurance" class="requirements-file-input">
  </div>
  <div class="requirements-form-row">
    <input type="checkbox" id="chkMoa" class="requirements-checkbox" readonly>
    <label for="reqMoa" class="requirements-label">MOA</label>
    <input type="file" name="moa" id="reqMoa" class="requirements-file-input">
  </div>
  <button type="submit" style="width:100%;padding:1em 0;font-size:1.16em;font-weight:700;border:none;border-radius:1em;background:linear-gradient(90deg,#101010,#052f10);color:#fff;cursor:pointer;">
    Submit Requirements
  </button>
</form>
  <div id="requirementsStatus" style="margin-top:1.5em;"></div>
</div>
</section>

      <section id="userTabContent-faqs" class="userTabContent" style="display:none;">
  <div id="userFaqsContainer" style="background:#fff;border-radius:1.5em;padding:2em;max-width:600px;margin:32px auto 0;box-shadow:0 2px 18px #0002;">
    <h2 style="text-align:center;font-weight:700;color:#2299ee;margin-bottom:1.2em;">FAQs / Ask a Question</h2>
    <form id="faqForm" autocomplete="off" style="margin-bottom:2em;">
      <input 
        type="text" 
        id="faqQuestion" 
        placeholder="Type your question..." 
        style="width:100%;padding:1em;margin-bottom:1em;background:#eafaf5;border:none;border-radius:1em;font-size:1.1em;color:#222;font-weight:500;outline:none;"
        required
      >
      <label style="display:block;color:#11695c;font-weight:500;margin-bottom:0.7em;">
        (Optional) Attach a picture
      </label>
      <input 
        type="file" 
        id="faqImg" 
        accept="image/*" 
        style="margin-bottom:1em;"
      >
      <button 
        type="submit" 
        style="width:100%;padding:0.8em 0;font-size:1.1em;font-weight:700;border:none;border-radius:1em;background:linear-gradient(90deg,#2299ee,#25a55f);color:#fff;cursor:pointer;">
        Post Question
      </button>
    </form>
    <div id="faqsList"></div>
  </div>
</section>

<section id="userTabContent-reports" class="userTabContent" style="display:none;">
  <div class="admin-report-card" id="userReportCard" style="margin-top:2em;">
    <h2>Generate Reports</h2>
    <div>
      <label class="admin-report-label" for="userReportRange">Choose Report Type:</label>
      <select id="userReportRange" class="admin-report-range">
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
        <option value="all">All Records</option>
      </select>
    </div>
    <button class="admin-report-btn" onclick="generateUserReport()"><i class="fas fa-file-alt"></i> Generate Report</button>
    <button class="admin-report-btn" onclick="exportUserReportPDF()"><i class="fas fa-file-pdf"></i> Export PDF</button>
    <button class="admin-report-btn" onclick="exportUserReportDOCX()"><i class="fas fa-file-word"></i> Export DOCX</button>
    <div class="admin-report-desc">
      Select a report range, then click generate to view your activity reports.
    </div>
    <div id="userReportResult" style="margin-top:2em;"></div>
  </div>
</section>

     <section id="userTabContent-settings" class="userTabContent" style="display:none;">
  <div style="max-width:420px;margin:2.5em auto;padding:2em;background:#fff;border-radius:18px;box-shadow:0 2px 14px #0002;">
    <h2 style="margin-bottom:1.2em;">Settings</h2>
    <div>
      <label style="font-weight:600;display:block;margin-bottom:.7em;">View My Logs Per Week</label>
      <button onclick="showUserWeeklyLogs()" class="form-btn" style="width:100%;">Show Weekly Logs</button>
      <div id="userWeeklyLogsResult" style="margin-top:1.3em;"></div>
    </div>
  </div>
</section>

 <section id="userTabContent-ojt" class="userTabContent" style="display:none;">
  <h3><i class="fas fa-calendar"></i> OJT HOURS</h3>
  <div id="userOjtOverview"></div>
  </section>



    </main>
  </div>
</div>


  <script>
    const reqTypes = [
  {id: "Resume", label: "Resume"},
  {id: "Endorsement", label: "Endorsement Letter"},
  {id: "Idpic", label: "2x2 ID Picture"},
  {id: "Medical", label: "Medical Certificate"},
  {id: "Waiver", label: "Waiver"},
  {id: "InternApp", label: "STUDENT INTERNS Application Form"},
  {id: "Contract", label: "INTERNSHIP CONTRACT/AGREEMENT"},
  {id: "Acceptance", label: "INTERNSHIP ACCEPTANCE LETTER"},
  {id: "Insurance", label: "INSURANCE"},
  {id: "Moa", label: "MOA"}
];

    let currentClassId = null;

   function showLogin(role) {
      document.getElementById('roleSelect').style.display = 'none';
      document.getElementById('classManagementSection').style.display = 'none';
      if (role === 'admin') {
        document.getElementById('adminLoginForm').style.display = 'block';
        document.getElementById('userLoginForm').style.display = 'none';
        document.getElementById('createAdminForm').style.display = 'none';
      } else {
        document.getElementById('userLoginForm').style.display = 'block';
        document.getElementById('adminLoginForm').style.display = 'none';
        document.getElementById('createAdminForm').style.display = 'none';
      }
    }

     function goBack() {
      document.getElementById('roleSelect').style.display = 'flex';
      document.getElementById('adminLoginForm').style.display = 'none';
      document.getElementById('userLoginForm').style.display = 'none';
      document.getElementById('createAdminForm').style.display = 'none';
      document.getElementById('classManagementSection').style.display = 'none';
    }

  function showCreateAdmin() {
      document.getElementById('adminLoginForm').style.display = 'none';
      document.getElementById('createAdminForm').style.display = 'block';
      document.getElementById('userLoginForm').style.display = 'none';
      document.getElementById('classManagementSection').style.display = 'none';
    }
 function goBackToAdminLogin() {
      document.getElementById('createAdminForm').style.display = 'none';
      document.getElementById('adminLoginForm').style.display = 'block';
      document.getElementById('userLoginForm').style.display = 'none';
      document.getElementById('classManagementSection').style.display = 'none';
    }

async function adminLogin(e) {
  e.preventDefault();
  const email = document.getElementById('adminEmail').value.trim();
  const password = document.getElementById('adminPassword').value.trim();

  try {
    const res = await fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });
    const data = await res.json();
    if (res.ok && data.token) {
      localStorage.setItem("authToken", data.token);
      localStorage.setItem("loggedInAdmin", email);
      // Save collaborators to localStorage/session
      localStorage.setItem("collaborators", JSON.stringify(data.collaborators || []));
      document.getElementById('adminLoginForm').style.display = 'none';
      document.getElementById('classManagementSection').style.display = 'block';
      renderClassList();
      renderCollaboratorsUI();
      populateCollabClassSelect(); 
    } else {
      alert('Login failed: ' + (data.error || 'Invalid credentials'));
    }
  } catch (err) {
    alert('Network error: ' + err.message);
  }
}

function toggleAdminPassword() {
  const pwd = document.getElementById('adminPassword');
  const eye = document.getElementById('adminEye');
  if (pwd.type === "password") {
    pwd.type = "text";
    eye.classList.remove('fa-eye');
    eye.classList.add('fa-eye-slash');
  } else {
    pwd.type = "password";
    eye.classList.remove('fa-eye-slash');
    eye.classList.add('fa-eye');
  }
}

function showAdminForgotPassword() {
  document.getElementById('adminLoginForm').style.display = 'none';
  document.getElementById('adminForgotPasswordForm').style.display = 'block';
}

function hideAdminForgotPassword() {
  document.getElementById('adminForgotPasswordForm').style.display = 'none';
  document.getElementById('adminLoginForm').style.display = 'block';
}

async function sendAdminPasswordReset() {
  const email = document.getElementById('forgotAdminEmail').value.trim();
  const msgDiv = document.getElementById('forgotAdminMessage');
  msgDiv.textContent = "";
  if (!email) {
    msgDiv.textContent = "Please enter your email.";
    return;
  }
  try {
    const res = await fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/admins/forgot-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email })
    });

    // Try to read JSON, but if response is not valid JSON, show raw text
    let bodyText = await res.text();
    let data = null;
    try {
      data = JSON.parse(bodyText);
    } catch (err) {
      // Not JSON -- show raw text
      msgDiv.textContent = "Server error: " + bodyText;
      return;
    }
    if (res.ok) {
      msgDiv.textContent = data.message || "If your email is registered, a reset link has been sent.";
    } else {
      msgDiv.textContent = data.error || "Failed to send reset link.";
    }
  } catch (err) {
    msgDiv.textContent = "Network error: " + err.message;
  }
}

async function addClass(event) {
  event.preventDefault();

  const course = document.getElementById('courseInput').value.trim();
  const section = document.getElementById('sectionInput').value.trim();
  const hours = document.getElementById('hoursInput').value.trim();
  const admin = localStorage.getItem("loggedInAdmin");

  if (!course || !section || !hours) return;

  try {
    const res = await fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/classes', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ course, section, hours, admin })
    });
    const data = await res.json();
    if (res.ok) {
      document.getElementById('courseInput').value = "";
      document.getElementById('sectionInput').value = "";
      document.getElementById('hoursInput').value = "";
      await renderClassList(); // re-fetch from backend
      populateCollabClassSelect();
    } else {
      alert('Error: ' + (data.error || 'Unable to add class.'));
    }
  } catch (err) {
    alert('Network error: ' + err.message);
  }
}


function toggleClassOptions(btn) {
  const menu = btn.nextElementSibling;
  menu.classList.toggle("show");
}

function manageCollaborators(course, section) {
  // Find the class object
  let classes = JSON.parse(localStorage.getItem("classes") || "[]");
  let cls = classes.find(c => c.course === course && c.section === section);
  if (!cls) {
    alert("Class not found.");
    return;
  }
  // Show the panel and load collaborators
  document.getElementById('classCollaboratorsPanel').style.display = 'block'; // Show panel
  document.getElementById('classCollaboratorsPanel').dataset.classId = cls.id; // Set class id
  showCollaboratorsPanel(cls); // Populate collaborators
}

async function editClass(classId) {
  // Only allow modal if NOT on student dashboard
  const userDashboard = document.getElementById('userDashboard');
  if (userDashboard && getComputedStyle(userDashboard).display !== 'none') {
    console.warn("Edit Class blocked: Student dashboard is active.");
    return;
  }

  // Only allow modal if admin/class management screen is visible
  const classMgmtVisible = getComputedStyle(document.getElementById('classManagementSection')).display !== 'none';
  const adminDashboardVisible = getComputedStyle(document.getElementById('adminDashboard')).display !== 'none';

  if (!classMgmtVisible && !adminDashboardVisible) {
    console.warn("Edit Class blocked: Not on admin/class management screen.");
    return;
  }

  try {
    const res = await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/classes/${classId}`);
    if (!res.ok) throw new Error('Failed to fetch class details');
    const cls = await res.json();

    document.getElementById('editClassModal').dataset.classId = cls.id;
    document.getElementById('editClassName').value = cls.course || '';
    document.getElementById('editClassSection').value = cls.section || '';
    document.getElementById('editClassHours').value = cls.hours || '';
    document.getElementById('editClassModal').style.display = 'flex';

  } catch (err) {
    console.error('Error opening edit modal:', err);
    alert('Unable to open class editor. Please try again.');
  }
}


async function saveClassEdits() {
  const modal = document.getElementById('editClassModal');
  const classId = modal.dataset.classId;
  const course = document.getElementById('editClassName').value.trim();
  const section = document.getElementById('editClassSection').value.trim();
  const hours = document.getElementById('editClassHours').value.trim();

  try {
    const res = await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/classes/${classId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ course, section, hours })
    });
    const data = await res.json();
    if (res.ok) {
      clearEditClassModal();
      await renderClassList();
      alert("Class updated!");
    } else {
      alert("Error: " + (data.error || "Update failed"));
    }
  } catch (err) {
    alert("Network error: " + err.message);
  }
}

function deleteClass(btn) {
  btn.closest(".class-item").remove();
}


function backToAdminLogin() {
  document.getElementById('classManagementSection').style.display = 'none';
  document.getElementById('adminLoginForm').style.display = 'block';
  document.getElementById('roleSelect').style.display = 'none';
  document.getElementById('userLoginForm').style.display = 'none';
  document.getElementById('createAdminForm').style.display = 'none';
}

async function renderClassList() {
  const admin = localStorage.getItem("loggedInAdmin");
  try {
    const res = await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/classes?admin=${encodeURIComponent(admin)}`);
    const classes = await res.json();
    localStorage.setItem("classes", JSON.stringify(classes)); // <-- keep localStorage updated!
    const listDiv = document.getElementById('classList');
    if (!Array.isArray(classes) || classes.length === 0) {
      listDiv.innerHTML = "<div style='color:#aaa;'>No classes created yet.</div>";
      return;
    }
    listDiv.innerHTML = "";
    classes.forEach((cls, idx) => {
      // Create a visible marker for classes that were assigned (not created by the admin)
      const assignedBadge = cls && (cls.assignedOnly === 1 || cls.assignedOnly === true)
        ? `<span style="display:inline-block;margin-left:8px;padding:6px 10px;background:#fff3cd;color:#856404;border-radius:12px;font-size:0.85rem;font-weight:700;">Assigned</span>`
        : '';

      let item = document.createElement('div');
      item.className = 'class-item';
      item.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="display:flex;align-items:center;gap:10px;">
              <div>
                <b>Course:</b> ${cls.course} <br>
                <b>Section:</b> ${cls.section} <br>
                <b>OJT Hours:</b> ${cls.hours}
              </div>
              <div style="margin-left:8px;">${assignedBadge}</div>
            </div>
          </div>
          <div class="class-options-group" style="position:relative;">
            <button class="class-options-btn" onclick="toggleClassOptionsMenu(event, ${cls.id})" style="background:transparent;border:none;font-size:1.3rem;color:#2299ee;cursor:pointer;padding:3px 12px;border-radius:50%;">
              <i class="fas fa-ellipsis-v"></i>
            </button>
            <div class="class-options-menu" id="class-options-menu-${cls.id}" style="display:none;position:absolute;right:0;top:28px;background:#fff;min-width:120px;border-radius:9px;box-shadow:0 5px 16px #25a55f22;z-index:10;padding:7px 0;">
              <button onclick="editClass(${cls.id})" style="display:block;width:100%;background:none;border:none;padding:10px 18px;text-align:left;cursor:pointer;font-size:1rem;color:#2a504a;">Edit</button>
              <button onclick="deleteClassConfirm(${cls.id})" style="display:block;width:100%;background:none;border:none;padding:10px 18px;text-align:left;cursor:pointer;font-size:1rem;color:#e74c3c;">Delete</button>
            </div>
          </div>
        </div>
      `;
      item.onclick = function(e) {
        if (e.target.closest('.class-options-btn') || e.target.closest('.class-options-menu')) return;
        openDashboard(cls, idx);
      };
      listDiv.appendChild(item);
    });
  } catch (err) {
    document.getElementById('classList').innerHTML = `<div style="color:red;">Failed to load classes from backend.</div>`;
  }
}

async function deleteClass(classId) {
  try {
    const res = await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/classes/${classId}`, { method: 'DELETE' });
    const data = await res.json();
    if (res.ok) {
      await renderClassList();
      alert("Class deleted!");
    } else {
      alert("Error: " + (data.error || "Delete failed"));
    }
  } catch (err) {
    alert("Network error: " + err.message);
  }
}

async function openDashboard(cls, idx) {
  currentClassId = cls.id;
  document.getElementById('classManagementSection').style.display = 'none';
  document.getElementById('adminDashboard').style.display = 'block';
  document.getElementById('dashboardClassName').innerText =
    `Admin Dashboard  ${cls.course} (${cls.section}), OJT Hours: ${cls.hours}`;
  showCollaboratorsPanel(cls);
  showTab('enroll'); // Default to first tab
}

function showTab(tab) {
  // Remove active from all tab buttons
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  // Hide all tab contents
  ['enroll', 'list', 'activities', 'requirements', 'ojt', 'faqs', 'reports', 'settings'].forEach(t => {
    var el = document.getElementById('tab-' + t);
    if (el) el.style.display = 'none';
  });
  // Show selected tab
  if (tab !== 'logout') {
    var showEl = document.getElementById('tab-' + tab);
    if (showEl) showEl.style.display = 'block';
    var btnEl = document.getElementById('tab' + capitalize(tab));
    if (btnEl) btnEl.classList.add('active');
    if (tab === 'list') renderStudentListTab();
    if (tab === 'activities') renderAdminActivitiesLogs();
    if (tab === 'requirements') renderAdminRequirements();
    if (tab === 'faqs') renderAdminFaqs();
    if (tab === 'ojt') renderAdminOjtOverview();
    if (tab === 'reports') populateAdminReportStudents();
  }
}

function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}
function logout() {
  localStorage.removeItem("loggedInAdmin");
  document.getElementById('adminDashboard').style.display = 'none';
  document.getElementById('classManagementSection').style.display = 'none';
  document.getElementById('adminLoginForm').style.display = 'block';
  renderClassList();
}

async function createAdmin(e) {
  e.preventDefault();
  const name = document.getElementById("newAdminName").value.trim().split(" ");
  const first = name[0];
  const last = name.slice(1).join(" ") || "";
  const email = document.getElementById("newAdminEmail").value.trim();
  const password = document.getElementById("newAdminPass").value.trim();
  const securityCode = document.getElementById("facultyCode").value.trim();

  try {
    const res = await fetch("https://slsu-ojt-monitoring-system-1.onrender.com/api/admins", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ first, last, email, password, securityCode })
    });
    const data = await res.json();
    if (res.ok) {
      alert("Admin account created successfully!");
      goBackToAdminLogin();
    } else {
      alert("Error: " + data.error);
    }
  } catch (err) {
    alert("Network error: " + err.message);
  }
}

function toggleNewAdminPassword() {
  const pwd = document.getElementById('newAdminPass');
  const eye = document.getElementById('newAdminEye');
  if (pwd.type === "password") {
    pwd.type = "text";
    eye.classList.remove('fa-eye');
    eye.classList.add('fa-eye-slash');
  } else {
    pwd.type = "password";
    eye.classList.remove('fa-eye-slash');
    eye.classList.add('fa-eye');
  }
}

// ---- Fetch Departments from Backend ----
async function getDepartments() {
  const res = await fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/departments');
  if (!res.ok) return [];
  return await res.json();
}


// ---- Load Department Options for Dropdowns ----
async function loadDeptOptions() {
  const select = document.getElementById('newAdminDept');
  select.innerHTML = "";
  const depts = await getDepartments();
  depts.forEach(dept => {
    const opt = document.createElement('option');
    opt.value = dept.name;
    opt.textContent = dept.name;
    select.appendChild(opt);
  });

  // Also update enroll dropdown
  const enrollSelect = document.getElementById('studDept');
  if (enrollSelect) {
    enrollSelect.innerHTML = "";
    const placeholder = document.createElement('option');
    placeholder.value = "";
    placeholder.textContent = "Select Department";
    placeholder.disabled = true;
    placeholder.selected = true;
    enrollSelect.appendChild(placeholder);
    depts.forEach(dept => {
      const opt = document.createElement('option');
      opt.value = dept.name;
      opt.textContent = dept.name;
      enrollSelect.appendChild(opt);
    });
  }
}

function openDeptManager() {
  document.getElementById('deptManagerModal').style.display = 'flex';
  renderDeptList();
}
function closeDeptManager() {
  document.getElementById('deptManagerModal').style.display = 'none';
  loadDeptOptions();
}

// ---- Render Department List ----
async function renderDeptList() {
  const ul = document.getElementById('deptList');
  ul.innerHTML = "";
  const depts = await getDepartments();
  depts.forEach(dept => {
    const li = document.createElement('li');
    li.innerHTML = `
      <span style="font-weight:600;color:#00695c;">${dept.name}</span>
      <span>
        <button class="dept-btn-action" onclick="editDepartment(${dept.id}, '${dept.name}')">
          <i class="fas fa-edit"></i> Edit
        </button>
        <button class="dept-btn-action" onclick="deleteDepartment(${dept.id})">
          <i class="fas fa-trash"></i> Delete
        </button>
      </span>
    `;
    ul.appendChild(li);
  });
}


// ---- Add Department ----
async function addDepartment() {
  const val = document.getElementById('deptInput').value.trim();
  if (!val) return;
  await fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/departments', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name: val })
  });
  document.getElementById('deptInput').value = "";
  renderDeptList();
  loadDeptOptions();
}

// ---- Edit Department ----
async function editDepartment(id, oldName) {
  const newVal = prompt("Edit department name:", oldName);
  if (!newVal || !newVal.trim()) return;
  await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/departments/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name: newVal.trim() })
  });
  renderDeptList();
  loadDeptOptions();
}

// ---- Delete Department ----
async function deleteDepartment(id) {
  if (!confirm("Delete this department?")) return;
  await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/departments/${id}`, { method: 'DELETE' });
  renderDeptList();
  loadDeptOptions();
}


// On modal open, show flex for centering
document.getElementById('deptManagerModal').style.display = 'none';

// Call this on page load for the options
loadDeptOptions();

async function populateDepartmentDropdown() {
  const select = document.getElementById('studDept');
  if (!select) return;
  select.innerHTML = "";
  const placeholder = document.createElement('option');
  placeholder.value = "";
  placeholder.textContent = "Select Department";
  placeholder.disabled = true;
  placeholder.selected = true;
  select.appendChild(placeholder);

  const depts = await getDepartments(); // <-- await!
  depts.forEach(dept => {
    const opt = document.createElement('option');
    opt.value = dept.name;
    opt.textContent = dept.name;
    select.appendChild(opt);
  });
}

// Optional: Event handler for when a department is selected
document.getElementById('studDept').addEventListener('change', function() {
  // You can place any logic here if you want to respond to the selection
  // Example: console.log('Selected department:', this.value);
});

// Populate the dropdown on page load
document.addEventListener('DOMContentLoaded', populateDepartmentDropdown);

async function enrollStudent(e) {
  e.preventDefault();
  // ... get form values ...
  const last = document.getElementById('studLast').value.trim();
  const first = document.getElementById('studFirst').value.trim();
  const middle = document.getElementById('studMiddle').value.trim();
  const ext = document.getElementById('studExt').value.trim();
  const dept = document.getElementById('studDept').value;
  const id = document.getElementById('studID').value.trim();
  const email = document.getElementById('studEmail').value.trim();
  const password = document.getElementById('studPass').value;

  if (!last || !first || !middle || !dept || !id || !email || !password) {
    alert("Please fill in all required fields.");
    return;
  }

  if (!currentClassId) {
    alert("No class selected!");
    return;
  }

  // Create student object
  const student = {
    last,
    first,
    middle,
    ext,
    dept,
    studid: id,
    email,
    password,
    classId: currentClassId // <-- Attach to current class!
  };

  // Send to backend
  try {
    const res = await fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/students', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(student)
    });
    const data = await res.json();
    if (res.ok) {
      alert('Student enrolled!');
      document.getElementById('enrollStudentForm').reset();
      if (typeof renderStudentListTab === "function") {
        renderStudentListTab();
      }
    } else {
      alert('Error: ' + (data.error || 'Could not enroll student'));
    }
  } catch (err) {
    alert('Network error: ' + err.message);
  }
}

async function renderStudentListTab() {
  const studentTableDiv = document.getElementById('studentTableScroll');
  if (!studentTableDiv) return;

  let students = [];
  try {
    const res = await fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/students');
    students = await res.json();
  } catch (err) {
    studentTableDiv.innerHTML = `<div style="color:red;">Failed to load students from backend.</div>`;
    return;
  }

  // Filter students by currentClassId
  if (!currentClassId) {
    studentTableDiv.innerHTML = `<div style="color:#888;">No class selected.</div>`;
    return;
  }
  const filteredStudents = students.filter(stud => Number(stud.classId) === Number(currentClassId));

  if (!Array.isArray(filteredStudents) || filteredStudents.length === 0) {
    studentTableDiv.innerHTML = `<div style="color:#888;padding:50px 0;text-align:center;">No students enrolled yet.</div>`;
    return;
  }

  let html = `
    <table class="ojt-admin-table">
      <thead>
        <tr>
          <th style="width:5%;">#</th>
          <th style="width:25%;">Name</th>
          <th style="width:20%;">Department</th>
          <th style="width:15%;">School ID</th>
          <th style="width:25%;">Email</th>
          <th style="width:10%;">Options</th>
        </tr>
      </thead>
      <tbody>
  `;
  filteredStudents.forEach((stud, i) => {
    const fullName = `${stud.last || ''}, ${stud.first || ''} ${stud.middle || ''} ${stud.ext ? (' ' + stud.ext) : ''}`.trim();
    html += `
      <tr>
        <td>${i + 1}</td>
        <td>${fullName}</td>
        <td>${stud.dept || '-'}</td>
        <td>${stud.studid || stud.id || ''}</td>
        <td>${stud.email || '-'}</td>
        <td style="position:relative;">
          <div class="student-options-group" style="position:relative;">
            <button class="student-options-btn" onclick="showStudentOptions(event, ${i})">
              <i class="fas fa-ellipsis-v"></i>
            </button>
            <div class="student-options-menu" id="student-options-menu-${i}">
             <button onclick="editStudent(${stud.id})">Edit</button>
    <button onclick="moveStudent(${stud.id})">Move</button>
    <button onclick="resetStudentPassword(${stud.id})">Reset Password</button>
    <button onclick="deleteStudent(${stud.id})">Delete</button>
            </div>
          </div>
        </td>
      </tr>
    `;
  });
  html += `</tbody></table>`;
  studentTableDiv.innerHTML = html;
}

function showStudentOptions(event, index) {
  event.stopPropagation();
  // Hide all other menus
  document.querySelectorAll('.student-options-menu').forEach(menu => {
    menu.classList.remove('show');
    menu.style.top = '36px';
    menu.style.bottom = '';
  });
  const menu = document.getElementById(`student-options-menu-${index}`);
  if (menu) {
    // Get button position
    const btn = event.currentTarget;
    const btnRect = btn.getBoundingClientRect();
    const menuHeight = menu.offsetHeight || 120; // fallback

    // If not enough space below, open upwards
    if (btnRect.bottom + menuHeight > window.innerHeight - 30) {
      menu.style.top = '';
      menu.style.bottom = '36px'; // Open upwards
    } else {
      menu.style.top = '36px'; // Open downwards
      menu.style.bottom = '';
    }

    menu.classList.toggle('show');
  }
}

// Hide open menu when clicking anywhere else
document.addEventListener('click', function(e) {
  document.querySelectorAll('.student-options-menu.show').forEach(menu => {
    menu.classList.remove('show');
    // Reset position for next open
    menu.style.top = '36px';
    menu.style.bottom = '';
  });
});

// Toggle the options menu
function toggleStudentMenu(index) {
  document.querySelectorAll('.student-options-menu').forEach(menu => {
    if (menu.id !== `studentMenu-${index}`) {
      menu.classList.remove('show');
    }
  });
  const menu = document.getElementById(`studentMenu-${index}`);
  menu.classList.toggle('show');
}

async function editStudent(studentId) {
  // Fetch student data from backend
  try {
    const res = await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/students/${studentId}`);
    if (!res.ok) throw new Error("Student not found");
    const stud = await res.json();
    // Fill modal form
    document.getElementById('editStudIdx').value = studentId; // use DB id
    document.getElementById('editStudLast').value = stud.last || "";
    document.getElementById('editStudFirst').value = stud.first || "";
    document.getElementById('editStudMiddle').value = stud.middle || "";
    document.getElementById('editStudExt').value = stud.ext || "";
    document.getElementById('editStudDept').value = stud.dept || "";
    document.getElementById('editStudID').value = stud.studid || "";
    document.getElementById('editStudEmail').value = stud.email || "";
    document.getElementById('editStudPass').value = stud.password || "";
    document.getElementById('editStudentModal').style.display = 'flex';
  } catch (err) {
    alert("Failed to load student: " + err.message);
  }
}

function closeEditStudentModal() {
  document.getElementById('editStudentModal').style.display = 'none';
}

document.getElementById('editStudentForm').onsubmit = async function(e) {
  e.preventDefault();
  let studentId = document.getElementById('editStudIdx').value;
  const student = {
    last: document.getElementById('editStudLast').value,
    first: document.getElementById('editStudFirst').value,
    middle: document.getElementById('editStudMiddle').value,
    ext: document.getElementById('editStudExt').value,
    dept: document.getElementById('editStudDept').value,
    studid: document.getElementById('editStudID').value,
    email: document.getElementById('editStudEmail').value,
    password: document.getElementById('editStudPass').value
  };
  try {
    const res = await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/students/${studentId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(student)
    });
    const data = await res.json();
    if (res.ok) {
      closeEditStudentModal();
      await renderStudentListTab();
      alert("Student updated!");
    } else {
      alert("Error: " + (data.error || "Update failed"));
    }
  } catch (err) {
    alert("Network error: " + err.message);
  }
};

async function moveStudent(studentId) {
  // Get classes from backend or localStorage (for now)
  let classes = JSON.parse(localStorage.getItem("classes") || "[]");
  if (classes.length === 0) {
    alert("No other classes found.");
    return;
  }
  let classNames = classes.map((c, i) => `${i + 1}. ${c.course} (${c.section})`).join('\n');
  let sel = prompt("Move this student to which class?\n" + classNames + "\nEnter number:");
  let selIdx = parseInt(sel) - 1;
  if (isNaN(selIdx) || !classes[selIdx]) return;

  let selectedClassId = classes[selIdx].id;

  try {
    const res = await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/students/${studentId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ classId: selectedClassId })
    });
    const data = await res.json();
    if (res.ok) {
      alert("Student moved!");
      await renderStudentListTab();
    } else {
      alert("Error: " + (data.error || "Move failed"));
    }
  } catch (err) {
    alert("Network error: " + err.message);
  }
}

async function resetStudentPassword(studentId) {
  let newPass = prompt("Enter a new password for this student:");
  if (!newPass || !newPass.trim()) return alert("Password reset cancelled.");
  try {
    const res = await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/students/${studentId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ password: newPass.trim() })
    });
    const data = await res.json();
    if (res.ok) {
      alert("Password has been reset.");
      await renderStudentListTab();
    } else {
      alert("Error: " + (data.error || "Reset failed"));
    }
  } catch (err) {
    alert("Network error: " + err.message);
  }
}

async function deleteStudent(studentId) {
  if (!confirm("Are you sure you want to delete this student?")) return;
  try {
    const res = await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/students/${studentId}`, {
      method: "DELETE"
    });
    const data = await res.json();
    if (res.ok) {
      alert("Student deleted!");
      await renderStudentListTab();
    } else {
      alert("Error: " + (data.error || "Delete failed"));
    }
  } catch (err) {
    alert("Network error: " + err.message);
  }
}

async function renderAdminActivitiesLogs() {
  const container = document.getElementById('adminActivitiesLogs');
  if (!container) return;

  container.innerHTML = `<div style="text-align:center;color:#888;padding:2em;">Loading activity logs...</div>`;

  try {
    // Fetch students and logs in parallel
    const [studentsRes, logsRes] = await Promise.all([
      fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/students'),
      fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/dailylogs')
    ]);

    const students = studentsRes.ok ? await studentsRes.json() : [];
    const allLogs = logsRes.ok ? await logsRes.json() : [];

    // Only include students in the CURRENT CLASS
    const classStudents = students.filter(s => Number(s.classId) === Number(currentClassId));
    const classStudentIds = new Set(classStudents.map(s => String(s.id)));
    const filteredLogs = allLogs.filter(log => classStudentIds.has(String(log.userId)));

    if (!Array.isArray(filteredLogs) || filteredLogs.length === 0) {
      container.innerHTML = "<p style='color:#888;text-align:center;'>No activity logs for this class yet.</p>";
      return;
    }

    // Render only logs for students enrolled in the current class
    let html = '';
    filteredLogs.forEach(log => {
      const uid = String(log.userId || 'guest');
      const student = classStudents.find(s => String(s.id) === uid) || { first: '', last: '', id: uid };
      const displayName = (student.first || student.last)
        ? `${student.last || ''}, ${student.first || ''}`.trim()
        : `User ${uid}`;
      const displayDate = log.date
        ? new Date(log.date).toLocaleString()
        : (log.uploadedAt ? new Date(log.uploadedAt).toLocaleString() : '');

      html += `
        <div style="background:#fff;border-radius:1em;padding:1.2em 1.8em;margin-bottom:1.5em;box-shadow:0 1px 6px #0001;">
          <div style="font-weight:600;color:#888;font-size:1.08em;margin-bottom:0.3em;">(${uid}) ${displayName}</div>
          <div style="color:#25a55f;font-size:0.98em;margin-bottom:0.45em;">${displayDate}</div>
          <div style="font-weight:700;margin:0.2em 0 0.6em 0;font-size:1.12em;color:#2299ee;">${log.title || ''}</div>
          <div style="margin-bottom:0.9em;color:#222;">${log.desc || ''}</div>
          ${log.img ? `<img src="${log.img}" style="max-width:320px;border-radius:10px;border:1px solid #ccc;margin-bottom:0.9em;display:block;">` : ""}

          <div style="margin-top:8px;">
            <b style="color:#2299ee;">Comments</b>
            <div id="comments-${uid}-${log.id}" style="margin-top:8px;">
              ${Array.isArray(log.comments) && log.comments.length
                ? log.comments.map((comment, ci) => `
                    <div style="margin:7px 0;padding:8px 12px;background:#f3f3f3;border-radius:7px;position:relative;">
                      <div style="font-weight:600;color:#11695c;">${comment.by || 'Admin'}</div>
                      <div style="color:#666;font-size:.9em;margin-top:4px;">${comment.text}</div>
                      <div style="color:#999;font-size:.8em;margin-top:6px;">${comment.timestamp ? new Date(comment.timestamp).toLocaleString() : ''}</div>
                     <div style="position:absolute;top:8px;right:16px;">
  <button class="menu-btn" onclick="toggleCommentMenu(${log.id},${ci},event)" style="background:none;border:none;cursor:pointer;font-size:1.5em;padding:0 7px;">&#x22EE;</button>
  <div id="comment-menu-${log.id}-${ci}" class="comment-menu" style="display:none;position:absolute;right:0;top:28px;min-width:75px;background:#fff;border:1px solid #e0e0e0;box-shadow:0 2px 10px #0003;border-radius:8px;z-index:1000;">
    <div onclick="editAdminActivityComment(${log.id},${ci})" style="padding:8px 15px;cursor:pointer;font-size:0.97em;border-bottom:1px solid #eee;">Edit</div>
    <div onclick="deleteAdminActivityComment(${log.id},${ci})" style="padding:8px 15px;cursor:pointer;font-size:0.97em;color:#e74c3c;">Delete</div>
  </div>
</div>
                    </div>
                  `).join('')
                : '<div style="color:#aaa;font-size:.97em;">No comments yet.</div>'}
            </div>

            <form onsubmit="addCommentToPost(event, '${uid}', '${log.id}')" style="margin-top:8px;display:flex;gap:7px;">
              <input type="text" name="comment" placeholder="Write a comment..." style="flex:1;padding:7px 10px;border-radius:7px;border:1px solid #b2dfdb;font-size:1em;" required>
              <button type="submit" style="padding:7px 18px;border-radius:7px;background:linear-gradient(90deg,#43a047,#25a55f);color:#fff;border:none;font-weight:600;cursor:pointer;">Post</button>
            </form>
          </div>
        </div>
      `;
    });

    container.innerHTML = html;
  } catch (err) {
    console.error('renderAdminActivitiesLogs error', err);
    container.innerHTML = `<div style="color:red;text-align:center;">Failed to load activity logs.</div>`;
  }
}

// Toggle the single comment's menu dropdown
function toggleCommentMenu(logId, ci, event) {
  event.stopPropagation();
  // Hide all menus first
  document.querySelectorAll('.comment-menu').forEach(menu => menu.style.display = 'none');
  // Show the selected menu
  const menu = document.getElementById(`comment-menu-${logId}-${ci}`);
  if (menu) menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
}

// Hide menu on outside click
window.addEventListener('click', function() {
  document.querySelectorAll('.comment-menu').forEach(menu => menu.style.display = 'none');
});

async function addCommentToPost(e, userId, logId) {
  e.preventDefault();
  const commentText = (e.target.comment && e.target.comment.value || '').trim();
  if (!commentText) return;

  try {
    // Fetch all logs from server and find the post by id
    const logsRes = await fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/dailylogs');
    if (!logsRes.ok) {
      alert('Failed to load posts from server');
      return;
    }
    const logs = await logsRes.json();
    const post = logs.find(l => String(l.id) === String(logId));
    if (!post) {
      alert('Post not found on server');
      return;
    }

    // Ensure comments array exists
    post.comments = Array.isArray(post.comments) ? post.comments : [];

    // Add admin comment
    const newComment = {
      text: commentText,
      by: localStorage.getItem('loggedInAdmin') || 'Admin',
      timestamp: new Date().toISOString()
    };
    post.comments.push(newComment);

    // PUT updated post back to server (endpoint already exists: PUT /api/dailylogs/:id)
    const updateResp = await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/dailylogs/${post.id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        title: post.title || '',
        desc: post.desc || '',
        img: post.img || '',
        comments: post.comments
      })
    });

    if (!updateResp.ok) {
      const errText = await updateResp.text().catch(() => '');
      console.error('Failed to save comment', updateResp.status, errText);
      alert('Failed to save comment on server.');
      return;
    }

    // Clear input and re-render admin activities
    if (e.target.comment) e.target.comment.value = '';
    await renderAdminActivitiesLogs();
  } catch (err) {
    console.error('addCommentToPost error', err);
    alert('Network error while posting comment. See console for details.');
  }
}
window.addCommentToPost = addCommentToPost;

// Edit comment function
async function editAdminActivityComment(logId, commentIdx) {
  // Fetch this log
  const res = await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/dailylogs`);
  if (!res.ok) return alert("Failed to load log.");
  const logs = await res.json();
  const log = logs.find(l => String(l.id) === String(logId));
  if (!log) return alert("Log not found.");

  const comment = log.comments?.[commentIdx];
  if (!comment) return alert("Comment not found.");

  const newText = prompt("Edit comment:", comment.text);
  if (newText !== null && newText.trim() !== "") {
    log.comments[commentIdx].text = newText.trim();
    // Save to backend
    await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/dailylogs/${logId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        title: log.title,
        desc: log.desc,
        img: log.img,
        comments: log.comments
      })
    });
    await renderAdminActivitiesLogs();
  }
}
window.editAdminActivityComment = editAdminActivityComment;

// Delete comment function
async function deleteAdminActivityComment(logId, commentIdx) {
  if (!confirm("Delete this comment?")) return;
  // Fetch this log
  const res = await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/dailylogs`);
  if (!res.ok) return alert("Failed to load log.");
  const logs = await res.json();
  const log = logs.find(l => String(l.id) === String(logId));
  if (!log) return alert("Log not found.");

  if (!Array.isArray(log.comments) || typeof commentIdx !== 'number' || commentIdx < 0 || commentIdx >= log.comments.length) {
    return alert("Comment not found.");
  }
  log.comments.splice(commentIdx, 1);
  // Save to backend
  await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/dailylogs/${logId}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      title: log.title,
      desc: log.desc,
      img: log.img,
      comments: log.comments
    })
  });
  await renderAdminActivitiesLogs();
}
window.deleteAdminActivityComment = deleteAdminActivityComment;

async function renderAdminRequirements() {
  try {
    const container = document.getElementById('adminRequirementsTable');
    if (!container) return;

    container.innerHTML = `<div style="text-align:center;color:#888;padding:3em 0;">Loading requirements...</div>`;

    // 1) Determine current class
    const classId = currentClassId;
    if (!classId) {
      container.innerHTML = `<div style="text-align:center;color:#e74c3c;padding:2em 0;">No class selected.</div>`;
      return;
    }

    // 2) Fetch all students and filter by classId
    let students = [];
    try {
      const res = await fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/students');
      if (res.ok) {
        const allStudents = await res.json();
        students = allStudents.filter(s => Number(s.classId) === Number(classId));
      } else {
        students = [];
      }
    } catch (e) {
      console.warn('Failed to fetch students:', e);
      students = [];
    }

    if (!students || students.length === 0) {
      container.innerHTML = `<div style="text-align:center;color:#888;padding:2em 0;">No students enrolled for this class.</div>`;
      return;
    }

    // 3) Fetch requirements for all students (we will map by studentId) 
    let allReqs = [];
    try {
      const reqResp = await fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/requirements'
);
      if (reqResp.ok) {
        allReqs = await reqResp.json();
      } else {
        allReqs = [];
      }
    } catch (e) {
      console.warn('Failed to fetch requirements:', e);
      allReqs = [];
    }

    // Normalize mapping by studentId string
    const reqByStudent = {};
    allReqs.forEach(r => {
      const sid = String(r.studentId);
      if (!reqByStudent[sid]) reqByStudent[sid] = {};
      reqByStudent[sid][String(r.type).toLowerCase()] = r.filename;
    });

    // Requirements table
    let html = `<div class="requirements-card">
      <h2 style="margin-bottom:1.3em;display:flex;align-items:center;gap:8px;">
        <i class="fas fa-file-alt" style="color:#43a047;"></i> Requirements
      </h2>
      <div style="overflow-x:auto;">
        <table class="requirements-table">
        <thead>
          <tr style="background:#eafaf5;">
            <th>School ID</th><th>Name</th>
            <th>Resume</th><th>Endorsement</th><th>2x2 ID</th><th>Medical</th>
            <th>Waiver</th><th>Application</th><th>Contract</th><th>Acceptance</th><th>Insurance</th><th>MOA</th>
          </tr>
        </thead>
        <tbody>`;

    const expectedTypes = ['resume','endorsement','idpic','medical','waiver','internapp','contract','acceptance','insurance','moa'];

    students.sort((a, b) => {
      const la = (a.last || '').toLowerCase(), lb = (b.last || '').toLowerCase();
      if (la < lb) return -1;
      if (la > lb) return 1;
      const fa = (a.first || '').toLowerCase(), fb = (b.first || '').toLowerCase();
      if (fa < fb) return -1;
      if (fa > fb) return 1;
      return 0;
    });

    students.forEach(stud => {
      const sid = String(stud.id);
      const reqs = reqByStudent[sid] || {};
      const fullName = `${stud.last || ''}, ${stud.first || ''} ${stud.middle || ''} ${stud.ext || ''}`.trim();
      html += `<tr>
        <td style="font-weight:600;color:#2299ee;">${stud.studid || stud.id}</td>
        <td>${fullName}</td>`;

      expectedTypes.forEach(t => {
        const filename = reqs[t] || null;
        if (filename) {
          const url = `https://slsu-ojt-monitoring-system-1.onrender.com/requirements/${filename}`;
          html += `<td style="text-align:center;"><a href="${url}" target="_blank" style="color:#2299ee;">View</a></td>`;
        } else {
          html += `<td style="text-align:center;color:#ccc;">-</td>`;
        }
      });

      html += `</tr>`;
    });

    html += `</tbody></table></div></div>`;
    container.innerHTML = html;
  } catch (err) {
    console.error('renderAdminRequirements error', err);
    const container = document.getElementById('adminRequirementsTable');
    if (container) container.innerHTML = `<div style="color:red;">Failed to load requirements.</div>`;
  }
}

// Helper to render file link or image preview
function renderReqFileLink(req, isImage) {
  if (!req) return '';
  if (isImage && req.data && req.type && req.type.startsWith("image/")) {
    return `<a href="${req.data}" download="${req.name}" target="_blank" style="text-decoration:none;">
      <img src="${req.data}" alt="ID Pic" style="max-width:50px;max-height:50px;border-radius:6px;border:1px solid #b2dfdb;vertical-align:middle;">
      <div style="font-size:.90em;color:#2299ee;margin-top:3px;">View</div>
    </a>`;
  }
  // For documents
  return `<a href="${req.data}" download="${req.name}" target="_blank" style="color:#2299ee;text-decoration:none;font-weight:500;">
    ${req.name ? req.name.slice(0, 18) : 'Download'}
  </a>`;
}

async function renderAdminFaqs() {
  const faqs = await getFaqs();
  const container = document.getElementById('adminFaqsList');
  if (!container) return;

  // 1. Fetch all students
  let enrolledStudents = [];
  try {
    const studentsResp = await fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/students');
    const allStudents = studentsResp.ok ? await studentsResp.json() : [];
    // Only include students in the CURRENT CLASS
    enrolledStudents = allStudents.filter(s => Number(s.classId) === Number(currentClassId));
  } catch (err) {
    enrolledStudents = [];
  }

  // Build a set of student IDs enrolled in the current class
  const enrolledStudentIds = new Set(enrolledStudents.map(s => String(s.id)));

  // 2. Filter faqs to only those posted by enrolled students
  const filteredFaqs = faqs.filter(faq => enrolledStudentIds.has(String(faq.userId)));

  if (filteredFaqs.length === 0) {
    container.innerHTML = "<p style='color:#888;text-align:center;'>No questions posted yet by students enrolled in this class.</p>";
    return;
  }

  container.innerHTML = filteredFaqs.map(faq => `
    <div style="background:#f8f8f8;border-radius:1em;padding:1em 2em 2em 2em;margin-bottom:1.6em;box-shadow:0 1px 6px #0001;">
      <div style="font-size:.96em;color:#2299ee;font-weight:500;">${faq.userName || "Anonymous"}</div>
      <div style="color:#999;font-size:.95em;margin-bottom:0.3em;">${new Date(faq.date).toLocaleString()}</div>
      <div style="margin-bottom:.8em;font-size:1.11em;color:#11695c;">${faq.question}</div>
      ${faq.img ? `<img src="${faq.img}" alt="faq-img" style="max-width:160px;border-radius:0.7em;border:1px solid #ccc;box-shadow:0 1px 3px #0002;margin-bottom:10px;">` : ""}
      <div>
        <b style="color:#2299ee;">Comments & Answers</b>
        <div id="admin-faq-comments-${faq.id}">
  ${Array.isArray(faq.comments) && faq.comments.length ?
    faq.comments.map((comment, ci) => `
      <div style="margin:7px 0 7px 0;padding:8px 12px;background:#eafaf5;border-radius:7px;position:relative;">
        <span style="color:#43a047;font-weight:600;">${comment.by || 'User'}</span>
        <span style="color:#888;font-size:.97em;margin-left:6px;">${new Date(comment.timestamp).toLocaleString()}</span>
        <div style="margin-top:3px;color:#222;">${comment.text}</div>
        <div style="position:absolute;top:8px;right:16px;">
  <button class="menu-btn" onclick="toggleFaqCommentMenu(${faq.id},${ci},event)" style="background:none;border:none;cursor:pointer;font-size:1.5em;padding:0 7px;">&#x22EE;</button>
  <div id="faq-comment-menu-${faq.id}-${ci}" class="comment-menu" style="display:none;position:absolute;right:0;top:28px;min-width:75px;background:#fff;border:1px solid #e0e0e0;box-shadow:0 2px 10px #0003;border-radius:8px;z-index:1000;">
    <div onclick="editAdminFaqComment(${faq.id},${ci})" style="padding:8px 15px;cursor:pointer;font-size:0.97em;border-bottom:1px solid #eee;">Edit</div>
    <div onclick="deleteAdminFaqComment(${faq.id},${ci})" style="padding:8px 15px;cursor:pointer;font-size:0.97em;color:#e74c3c;">Delete</div>
  </div>
</div>
    `).join('')
  : '<div style="color:#aaa;font-size:.97em;">No answers yet.</div>'}
</div>
        <form onsubmit="addCommentToFaq(event, ${faq.id})" style="margin-top:8px;display:flex;gap:7px;">
          <input type="text" name="comment" placeholder="Type an answer..." style="flex:1;padding:7px 10px;border-radius:7px;border:1px solid #b2dfdb;font-size:1em;" required>
          <button type="submit" style="padding:7px 18px;border-radius:7px;background:linear-gradient(90deg,#43a047,#2299ee);color:#fff;border:none;font-weight:600;cursor:pointer;">Post</button>
        </form>
      </div>
    </div>
  `).join('');
}

function toggleFaqCommentMenu(faqId, ci, event) {
  event.stopPropagation();
  document.querySelectorAll('.comment-menu').forEach(menu => menu.style.display = 'none');
  const menu = document.getElementById(`faq-comment-menu-${faqId}-${ci}`);
  if (menu) menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
}
window.addEventListener('click', function() {
  document.querySelectorAll('.comment-menu').forEach(menu => menu.style.display = 'none');
});

// Edit comment on FAQ (admin)
async function editAdminFaqComment(faqId, commentIdx) {
  const res = await fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/faqs');
  if (!res.ok) return alert("Failed to load FAQs.");
  const faqs = await res.json();
  const faq = faqs.find(f => String(f.id) === String(faqId));
  if (!faq) return alert("FAQ not found.");
  const comment = faq.comments?.[commentIdx];
  if (!comment) return alert("Comment not found.");

  const newText = prompt("Edit comment:", comment.text);
  if (newText !== null && newText.trim() !== "") {
    faq.comments[commentIdx].text = newText.trim();
    await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/faqs/${faqId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ comments: faq.comments })
    });
    await renderAdminFaqs();
  }
}
window.editAdminFaqComment = editAdminFaqComment;

// Delete comment on FAQ (admin)
async function deleteAdminFaqComment(faqId, commentIdx) {
  if (!confirm("Delete this comment?")) return;
  const res = await fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/faqs');
  if (!res.ok) return alert("Failed to load FAQs.");
  const faqs = await res.json();
  const faq = faqs.find(f => String(f.id) === String(faqId));
  if (!faq) return alert("FAQ not found.");
  if (!Array.isArray(faq.comments) || typeof commentIdx !== 'number' || commentIdx < 0 || commentIdx >= faq.comments.length) {
    return alert("Comment not found.");
  }
  faq.comments.splice(commentIdx, 1);
  await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/faqs/${faqId}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ comments: faq.comments })
  });
  await renderAdminFaqs();
}
window.deleteAdminFaqComment = deleteAdminFaqComment;

async function renderAdminOjtOverview() {
  // Get all students and classes as before
  const students = JSON.parse(localStorage.getItem('students') || "[]");
  const classes = JSON.parse(localStorage.getItem('classes') || "[]");

  // Only include students enrolled in the CURRENT CLASS
  // currentClassId is set when you open the dashboard for a class
  const classId = currentClassId;
  const filteredStudents = students.filter(stud => Number(stud.classId) === Number(classId));

  let html = "";
  if (filteredStudents.length === 0) {
    html = '<div style="color:#888;padding:2em;text-align:center;">No students enrolled in this class yet.</div>';
  } else {
    html += `<table class="ojt-admin-table">
      <thead>
        <tr>
          <th>Student Name</th>
          <th>Department</th>
          <th>OJT Required</th>
          <th>Accomplished</th>
          <th>Remaining</th>
          <th>Progress</th>
        </tr>
      </thead>
      <tbody>`;

    // For each student, fetch their OJT logs from backend
    for (const stud of filteredStudents) {
      let studClass = classes.find(c => Number(c.id) === Number(classId));
      let required = studClass ? parseInt(studClass.hours || 0) : 300;
      const logs = await getOjtLogs(stud.id);
      let completed = 0;
      logs.forEach(log => {
        if (log.clockIn && log.clockOut) {
          let t1 = new Date(log.clockIn).getTime();
          let t2 = new Date(log.clockOut).getTime();
          if (t2 > t1) completed += (t2 - t1) / (1000 * 60 * 60);
        }
      });
      completed = Math.round(completed * 100) / 100;
      let remaining = Math.max(0, Math.round((required - completed) * 100) / 100);
      let percent = required > 0 ? Math.min(100, Math.round(completed / required * 100)) : 0;

      html += `
        <tr>
          <td><b>${stud.last}, ${stud.first} ${stud.middle ? stud.middle : ""} ${stud.ext ? (' ' + stud.ext) : ''}</b></td>
          <td>${stud.dept || '-'}</td>
          <td>${required}</td>
          <td class="ojt-accomplished">${completed}</td>
          <td class="ojt-remaining">${remaining}</td>
          <td>
            <div class="ojt-progress-bg">
              <div class="ojt-progress" style="width:${percent}%;"></div>
            </div>
            <span style="font-size:.93em;color:#888;">${percent}%</span>
          </td>
        </tr>
      `;
    }
    html += "</tbody></table>";
  }
  const container = document.getElementById('tab-ojt');
  if (container) container.innerHTML = html;
}

function populateAdminReportStudents() {
  const students = JSON.parse(localStorage.getItem('students') || "[]");
  const select = document.getElementById('adminReportStudent');
  select.innerHTML = "";
  if (students.length === 0) {
    select.innerHTML = "<option value=''>No students enrolled</option>";
    return;
  }
  students.forEach(stud => {
    let label = `${stud.id} (${stud.dept || '-'}) - ${stud.last}, ${stud.first}`;
    let option = document.createElement('option');
    option.value = stud.id;
    option.textContent = label;
    select.appendChild(option);
  });
}

async function generateAdminReport() {
  const studentId = document.getElementById('adminReportStudent').value;
  const range = document.getElementById('adminReportRange').value;
  const includeLogs = document.getElementById('includeLogs').checked;
  const includeFaqs = document.getElementById('includeFaqs').checked;

  const students = JSON.parse(localStorage.getItem('students') || "[]");
  const student = students.find(s => s.id == studentId);

  let html = "";
  if (!student) {
    html = `<div style="color:#e74c3c;">No student selected.</div>`;
    document.getElementById('adminReportResult').innerHTML = html;
    return;
  }

  html = `<h3>Report for ${student.last}, ${student.first} (${student.id})</h3>`;

  // --- OJT Time-in/out logs (from backend) ---
  const clockLogs = await getOjtLogs(studentId);
  if (clockLogs.length > 0) {
    html += `<h4>Time In/Out Records</h4><ul style="margin:0 0 1em 1em;">`;
    clockLogs.forEach(log => {
      html += `<li>
        <b>In:</b> ${log.clockIn ? new Date(log.clockIn).toLocaleString() : "-"}
        &nbsp; <b>Out:</b> ${log.clockOut ? new Date(log.clockOut).toLocaleString() : "-"}
        ${log.photo ? `<br><img src="${log.photo}" alt="Time-in photo" style="max-width:120px;max-height:100px;margin:5px 0;border-radius:8px;border:1px solid #ccc;">` : ""}
      </li>`;
    });
    html += `</ul>`;
  }

  // --- Uploaded Requirements ---
  const reqTypes = [
    {id: "Resume", label: "Resume"},
    {id: "Endorsement", label: "Endorsement Letter"},
    {id: "Idpic", label: "2x2 ID Picture"},
    {id: "Medical", label: "Medical Certificate"},
    {id: "Waiver", label: "Waiver"},
    {id: "InternApp", label: "STUDENT INTERNS Application Form"},
    {id: "Contract", label: "INTERNSHIP CONTRACT/AGREEMENT"},
    {id: "Acceptance", label: "INTERNSHIP ACCEPTANCE LETTER"},
    {id: "Insurance", label: "INSURANCE"},
    {id: "Moa", label: "MOA"}
  ];
  const requirements = await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/requirements/${studentId}`).then(r => r.ok ? r.json() : []);
  html += `<h4>Uploaded Requirements</h4>`;
  if (requirements.length === 0) {
    html += `<div style="color:#888;">No requirements uploaded yet.</div>`;
  } else {
    html += `<ul style="margin:0 0 1em 1em;">`;
    reqTypes.forEach(({id, label}) => {
      const file = requirements.find(f => f.type.toLowerCase() === id.toLowerCase());
      if (file) {
        const fileUrl = `https://slsu-ojt-monitoring-system-1.onrender.com/requirements/${file.filename}`;
        html += `<li><b>${label}:</b> <a href="${fileUrl}" target="_blank" style="color:#2299ee;">View/Download</a></li>`;
      } else {
        html += `<li><b>${label}:</b> <span style="color:#bbb;">Not uploaded</span></li>`;
      }
    });
    html += `</ul>`;
  }

  // --- Daily Logs (from backend) ---
  if (includeLogs) {
    const dailyLogs = await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/dailylogs/${studentId}`).then(r => r.ok ? r.json() : []);
    let filteredLogs = dailyLogs;
    if (range === "daily") {
      const today = new Date().toLocaleDateString();
      filteredLogs = dailyLogs.filter(log =>
        log.date && new Date(log.date).toLocaleDateString() === today
      );
    } else if (range === "weekly") {
      const now = new Date();
      const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      filteredLogs = dailyLogs.filter(log =>
        log.date && new Date(log.date) >= weekAgo
      );
    } else if (range === "monthly") {
      const now = new Date();
      const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
      filteredLogs = dailyLogs.filter(log =>
        log.date && new Date(log.date) >= monthAgo
      );
    }
    html += `<h4>Daily Logs</h4>`;
    if (filteredLogs.length === 0) {
      html += `<div style="color:#888;">No daily logs found for this range.</div>`;
    } else {
      html += `<ul style="margin:0 0 1em 1em;">` +
        filteredLogs.map(log =>
          `<li>
            <b>${log.title || ""}</b> <br>
            <span style="color:#888;">${log.date ? new Date(log.date).toLocaleString() : ""}</span><br>
            <span>${log.desc || ""}</span>
            ${log.img ? `<br><img src="${log.img}" alt="Activity photo" style="max-width:160px;max-height:120px;margin:5px 0;border-radius:8px;border:1px solid #ccc;">` : ""}
          </li>`
        ).join('') + `</ul>`;
    }
  }

  // --- FAQs (from backend, filter by studentId) ---
  if (includeFaqs) {
    const faqs = await fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/faqs').then(r => r.ok ? r.json() : []);
    const studentFaqs = faqs.filter(f => `${f.userId}` === `${studentId}`);
    html += `<h4>FAQs</h4>`;
    if (studentFaqs.length === 0) {
      html += `<div style="color:#888;">No FAQs found for this student.</div>`;
    } else {
      html += `<ul style="margin:0 0 1em 1em;">` + studentFaqs.map(faq =>
        `<li>
          <b>Q:</b> ${faq.question} <br>
          <span style="color:#888;">${faq.date ? new Date(faq.date).toLocaleString() : ""}</span>
          ${faq.img ? `<br><img src="${faq.img}" alt="FAQ photo" style="max-width:140px;max-height:100px;margin:5px 0;border-radius:8px;border:1px solid #ccc;">` : ""}
        </li>`
      ).join('') + `</ul>`;
    }
  }

  document.getElementById('adminReportResult').innerHTML = html;
}

function exportAdminReportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "pt", "a4"); // portrait, points, A4 size

    const reportElement = document.getElementById("adminReportResult");
    if (!reportElement) {
        console.error("Element with ID 'adminReportResult' not found.");
        alert("Please generate the report before exporting to PDF.");
        return;
    }

    try {
        //  Add universal page-break CSS before generating
        const style = document.createElement("style");
        style.innerHTML = `
            /* Prevent cutting content mid-section */
            .page-break,
            [data-page-break],
            section,
            article,
            .report-section {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }

            /* Force new page for large sections or headings */
            h1, h2, h3 {
                page-break-before: always;
                break-before: page;
            }

            /* Avoid orphan headings at page bottom */
            h1, h2, h3, h4 {
                page-break-after: avoid;
                break-after: avoid;
            }

            /* General layout safety */
            table, img, p {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }
        `;
        document.head.appendChild(style);

        // Margins (in points)
        const topMargin = 72;     // 1 inch
        const leftMargin = 90;    // 1.25 inch
        const rightMargin = 72;   // 1 inch
        const bottomMargin = 72;  // 1 inch

        const pageWidth = doc.internal.pageSize.getWidth();
        const contentMaxWidth = pageWidth - leftMargin - rightMargin;

        // Set default font to Times New Roman, size 12
        doc.setFont("Times", ""); // built-in Times-Roman family
        doc.setFontSize(12);

        // Render the HTML content into the PDF
        doc.html(reportElement, {
            callback: function (doc) {
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFont("Times", "italic");
                    doc.setFontSize(10);
                    doc.text(
                        `Page ${i} of ${pageCount}`,
                        leftMargin,
                        doc.internal.pageSize.height - 30
                    );
                }

                // Remove the temporary style after use
                document.head.removeChild(style);

                // Save the final document
                doc.save("admin_report.pdf");
            },
            x: leftMargin,
            y: topMargin,
            width: contentMaxWidth,
            autoPaging: "text",
            html2canvas: {
                scale: 0.9,
                useCORS: true,
                backgroundColor: "#ffffff",
                scrollX: 0,
                scrollY: 0
            },
            windowWidth: reportElement.scrollWidth
        }).catch(err => {
            console.error("PDF generation failed:", err);
            alert("Failed to generate PDF. Check console for details.");
        });

    } catch (error) {
        console.error("Unexpected error while generating PDF:", error);
        alert("An unexpected error occurred while creating the PDF.");
    }
}


function exportAdminReportDOCX() {
  const reportContent = document.getElementById('adminReportResult').innerHTML;
  if (!reportContent.trim()) {
    alert("Please generate a report first.");
    return;
  }

  // Wrap the content in a minimal HTML document
  const fullHTML = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>Admin Report</title>
    </head>
    <body>
      ${reportContent}
    </body>
    </html>
  `;

  // Convert HTML to DOCX Blob
  const docxBlob = htmlDocx.asBlob(fullHTML);
  
  // Trigger download
  const link = document.createElement('a');
  link.href = URL.createObjectURL(docxBlob);
  link.download = 'Admin_Report.docx';
  link.click();
}


// RESET DATA
function resetSystemData() {
  if (confirm("Are you sure you want to reset all demo data? This cannot be undone!")) {
    localStorage.clear();
    alert("All data has been reset. Reloading...");
    location.reload();
  }
}

async function deleteAdminAccount() {
  // Strong explicit confirmations
  if (!confirm("WARNING: This will DELETE YOUR ADMIN ACCOUNT AND ALL DATA YOU OWN (classes, students, requirements, logs, FAQs). This is irreversible. Continue?")) return;

  const token = localStorage.getItem('authToken');
  let payload = { confirm: 'DELETE_ACCOUNT' };
  let useAuthHeader = false;
  let headers = { 'Content-Type': 'application/json' };

  if (token) {
    useAuthHeader = true;
  } else {
    // fallback: ask for email/password
    const email = prompt('Enter your admin email to confirm:');
    if (!email) return alert('Canceled: email required.');
    const password = prompt('Enter your admin password to confirm deletion:');
    if (!password) return alert('Canceled: password required.');
    payload.email = email;
    payload.password = password;
  }

  try {
    const res = await fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/admins/delete-my-account', {
      method: 'POST',
      headers: useAuthHeader ? { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token } : headers,
      body: JSON.stringify(payload)
    });

    const data = await res.json().catch(() => ({}));
    if (res.ok) {
      // Clear local state and reload to login screen
      localStorage.clear();
      alert(data.message || 'Your admin account and your owned data have been deleted.');
      location.reload();
    } else {
      alert('Failed: ' + (data.error || ('Server returned ' + res.status)));
    }
  } catch (err) {
    alert('Network error: ' + err.message);
  }
}

// WEEKLY STUDENT LOGS
function populateLogsStudentSelect() {
  const students = JSON.parse(localStorage.getItem('students') || "[]");
  const select = document.getElementById('logsStudentSelect');
  if (!select) return;
  select.innerHTML = "<option value=''>Select Student</option>";
  students.forEach(stud => {
    let opt = document.createElement('option');
    opt.value = stud.id;
    opt.textContent = `${stud.id} - ${stud.last}, ${stud.first}`;
    select.appendChild(opt);
  });
}
document.addEventListener('DOMContentLoaded', populateLogsStudentSelect);

async function showStudentWeeklyLogs() {
  const studentId = document.getElementById('logsStudentSelect').value;
  const logs = await getOjtLogs(studentId);
  if (!studentId || logs.length === 0) {
    document.getElementById('weeklyLogsResult').innerHTML = "<div style='color:#888;'>No logs available for this student.</div>";
    return;
  }
  let grouped = {};
  logs.forEach(log => {
    if (!log.clockIn) return;
    let d = new Date(log.clockIn);
    let week = getISOWeek(d);
    let year = d.getFullYear();
    let key = `${year}-W${week}`;
    if (!grouped[key]) grouped[key] = [];
    grouped[key].push(log);
  });
  let html = "<h4>Weekly Log Summary</h4>";
  Object.keys(grouped).sort().reverse().forEach(week => {
    html += `<div style="margin-bottom:1.2em;"><b>${week}</b><ul style="margin:.5em 0 0 1em;">`;
    grouped[week].forEach(log => {
      html += `<li>${log.clockIn ? new Date(log.clockIn).toLocaleString() : '-'}  ${log.clockOut ? new Date(log.clockOut).toLocaleString() : '-'} (${log.clockIn && log.clockOut ? (((new Date(log.clockOut)-new Date(log.clockIn))/3600000).toFixed(2) + ' hrs') : ''})</li>`;
    });
    html += `</ul></div>`;
  });
  document.getElementById('weeklyLogsResult').innerHTML = html;
}

function getISOWeek(date) {
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
}

async function userLogin(e) {
  e.preventDefault();
  const schoolId = document.getElementById("userID").value.trim();
  const password = document.getElementById("userPassword").value.trim();

  if (!schoolId || !password) {
    alert("Please enter your School ID and password.");
    return;
  }

  try {
    const res = await fetch("https://slsu-ojt-monitoring-system-1.onrender.com/api/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ schoolId, password })
    });
    const data = await res.json();

    if (res.ok && data.token) {
      // Store user info in localStorage for dashboard use
      localStorage.setItem("authToken", data.token);
      localStorage.setItem("currentUserId", data.user.id);
      localStorage.setItem("currentUserName", `${data.user.first} ${data.user.last}`);
      localStorage.setItem("userDepartment", data.user.dept);
      localStorage.setItem("studentStudid", data.user.studid);
      localStorage.setItem("studentEmail", data.user.email);

      // Hide login form and show dashboard
      document.getElementById('userLoginForm').style.display = 'none';
      showUserDashboard();
    } else {
      alert(data.error || "Login failed. Please check your School ID and password.");
    }
  } catch (err) {
    alert("Network error: " + err.message);
  }
}

function toggleUserPassword() {
  const pwd = document.getElementById('userPassword');
  const eye = document.getElementById('userEye');
  if (pwd.type === "password") {
    pwd.type = "text";
    eye.classList.remove('fa-eye');
    eye.classList.add('fa-eye-slash');
  } else {
    pwd.type = "password";
    eye.classList.remove('fa-eye-slash');
    eye.classList.add('fa-eye');
  }
}

async function showUserDashboard() {
  document.getElementById('userDashboard').style.display = 'block';

  const userId = localStorage.getItem('currentUserId') || null;
  const storedName = localStorage.getItem('currentUserName') || '';
  const storedDept = localStorage.getItem('userDepartment') || '';
  const storedOjtTotal = localStorage.getItem('userOjtTotal') || '';

  // Try to find student in localStorage cache first
  let students = [];
  try {
    students = JSON.parse(localStorage.getItem('students') || '[]');
  } catch (e) {
    students = [];
  }

  let user = null;
  if (userId) {
    user = students.find(u => String(u.id) === String(userId)) || null;
  }

  // If we still don't have a user object, try server lookup (best-effort)
  if (!user && userId) {
    try {
      const res = await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/students/${encodeURIComponent(userId)}`);
      if (res.ok) {
        user = await res.json();
        // update local cache (merge)
        try {
          const existing = Array.isArray(students) ? students : [];
          const idx = existing.findIndex(s => String(s.id) === String(user.id));
          if (idx === -1) {
            existing.push(user);
          } else {
            existing[idx] = user;
          }
          localStorage.setItem('students', JSON.stringify(existing));
        } catch (e) { /* ignore cache failures */ }
      }
    } catch (e) {
      console.warn('Failed to fetch student from server:', e);
    }
  }

  // Choose display name: prefer localStorage currentUserName (login sets it), then user object, then fallback label
  let displayName = 'Student';
  if (storedName && storedName.trim()) {
    displayName = storedName.trim();
  } else if (user && (user.first || user.last)) {
    displayName = `${(user.first || '').trim()} ${(user.last || '').trim()}`.trim();
  } else if (user && user.email) {
    displayName = user.email;
  }

  // Department: prefer user.dept, fall back to localStorage storedDept, then '-'
  const department = (user && user.dept) ? user.dept : (storedDept || '-');

  // OJT total hours: prefer class-related info or user.ojt; fallback to storedOjtTotal or 300
  // If user has classId and classes cache exists, try to lookup class hours
  let ojtTotal = storedOjtTotal || '';
  try {
    if ((!ojtTotal || ojtTotal === '') && user && user.classId) {
      const classes = JSON.parse(localStorage.getItem('classes') || '[]');
      const cls = Array.isArray(classes) ? classes.find(c => String(c.id) === String(user.classId)) : null;
      if (cls && cls.hours) ojtTotal = String(cls.hours);
    }
  } catch (e) { /* ignore */ }

  if ((!ojtTotal || ojtTotal === '') && user && (user.ojt || user.hours)) {
    ojtTotal = String(user.ojt || user.hours);
  }
  if (!ojtTotal || ojtTotal === '') ojtTotal = storedOjtTotal || '300';

  // Status (timed in / out)
  const timedIn = getUserTimedInStatus();
  const statusText = timedIn ? 'Timed In' : 'Timed Out';

  // Set DOM
  const nameEl = document.getElementById('userName');
  if (nameEl) nameEl.innerText = displayName;

  const deptEl = document.getElementById('userDept');
  if (deptEl) deptEl.innerText = (department && department !== '') ? department : '-';

  const ojtEl = document.getElementById('userOjtTotal');
  if (ojtEl) ojtEl.innerText = ojtTotal;

  const statusEl1 = document.getElementById('userTimedInStatus');
  const statusEl2 = document.getElementById('userTimedInStatus2');
  if (statusEl1) statusEl1.innerText = statusText;
  if (statusEl2) statusEl2.innerText = statusText;

  updateUserClock();
}

function showUserTab(tab) {
  document.querySelectorAll('.userTabContent').forEach(el => el.style.display = 'none');
  document.querySelectorAll('.user-dashboard-menu button').forEach(btn => btn.classList.remove('active'));
var content = document.getElementById('userTabContent-' + tab);
  if (content) content.style.display = 'block';
  var btnEl = document.getElementById('userTab' + capitalize(tab));
  if (btnEl) btnEl.classList.add('active');
  if (tab === 'ojt') renderUserOjtOverview();
}

function capitalize(str) { return str.charAt(0).toUpperCase() + str.slice(1); }
// Simulate timed in status (replace this with your actual logic!)

async function getUserTimedInStatus() {
  const userId = localStorage.getItem("currentUserId");
  if (!userId) return false;
  const logs = await getOjtLogs(userId);
  return logs.some(log => log.clockIn && !log.clockOut);
}


async function saveClockOutLog() {
  const userId = localStorage.getItem("currentUserId");
  const logs = await getOjtLogs(userId);
  const lastLog = logs.find(log => log.clockIn && !log.clockOut);
  if (!lastLog) return;
  const now = new Date().toISOString();
  const res = await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/ojtlogs/${lastLog.id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ clockOut: now })
  });
  if (res.ok) {
    localStorage.setItem("userTimedIn", "false");
    updateClockButtons();
    renderClockTabRecords();
    renderLastClockRecord();
  } else {
    alert('Clock out failed!');
  }
}

// Only keep this version!
async function updateClockButtons() {
  const timedIn = await getUserTimedInStatus();
  if (timedIn) {
    document.getElementById('clockInBtn').style.display = "none";
    document.getElementById('clockOutBtn').style.display = "inline-block";
  } else {
    document.getElementById('clockInBtn').style.display = "inline-block";
    document.getElementById('clockOutBtn').style.display = "none";
  }
}

async function clockOut() {
  if (!(await getUserTimedInStatus())) {
    document.getElementById('clockMessage').innerText = "Already timed out!";
    return;
  }
  await saveClockOutLog();
  document.getElementById('clockMessage').innerText = "Clocked out successfully!";
  renderLastClockRecord();
  renderClockTabRecords();
}

// Update the time
function updateUserClock() {
  const now = new Date();
  document.getElementById('userCurrentTime').innerText =
    now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  setTimeout(updateUserClock, 1000);
}

// Dummy logout
function userLogout() {
  localStorage.removeItem("userTimedIn");
  document.getElementById('userDashboard').style.display = 'none';
  document.getElementById('userLoginForm').style.display = 'block';
  // show login UI here
}
// On load, show dashboard (for demo, call showUserDashboard() after login)
window.showUserDashboard = showUserDashboard; // Expose for manual call
window.showUserTab = showUserTab;
// Optional: Automatically show Clock tab on dashboard load
document.addEventListener("DOMContentLoaded", function() {
  if (document.getElementById('userDashboard')) {
    showUserTab('clock');
    updateClockButtons();
  }
  
});

let webcamStream = null;

function startClockInProcess() {
  // Show webcam section
  document.getElementById('webcamSection').style.display = 'block';
  document.getElementById('clockMessage').innerText = '';
  // Hide normal Clock In button to prevent double click
  document.getElementById('clockInBtn').style.display = 'none';

  // Start webcam
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
      webcamStream = stream;
      const video = document.getElementById('webcamVideo');
      video.srcObject = stream;
    })
    .catch(err => {
      alert('Could not access camera: ' + err);
      document.getElementById('webcamSection').style.display = 'none';
      document.getElementById('clockInBtn').style.display = 'inline-block';
    });
}

function capturePhoto() {
  const video = document.getElementById('webcamVideo');
  const canvas = document.getElementById('webcamCanvas');
  const img = document.getElementById('capturedPhoto');
  canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
  // Get data URL of the photo
  const photoData = canvas.toDataURL('image/png');
  img.src = photoData;
  img.style.display = 'block';

  // Stop the webcam stream
  if (webcamStream) {
    webcamStream.getTracks().forEach(track => track.stop());
  }
  document.getElementById('webcamSection').style.display = 'none';

  // Mark the user as Timed In
  localStorage.setItem("userTimedIn", "true");
  document.getElementById('userTimedInStatus').innerText = "Timed In";
  document.getElementById('userTimedInStatus2').innerText = "Timed In";
  document.getElementById('clockOutBtn').style.display = "inline-block";
  document.getElementById('clockInBtn').style.display = "none";
  document.getElementById('clockMessage').innerHTML = "<span style='color:#25a55f;font-weight:600;'>Timed OK</span>";

  // Optionally, save photoData to localStorage or send it to a server
  // localStorage.setItem("userClockInPhoto", photoData);
  saveClockInLog(photoData);
  renderLastClockRecord(); // <-- Add this line
}

async function renderLastClockRecord() {
  const logs = await getOjtLogs();
  const lastDiv = document.getElementById('lastRecord');
  if (!lastDiv) return;
  if (!logs || logs.length === 0) {
    lastDiv.innerHTML = "";
    return;
  }
  const lastLog = logs[0];
  let html = "";
  if (lastLog.clockIn) {
    html += "<b>Last Time In:</b> " + new Date(lastLog.clockIn).toLocaleString() + "<br>";
  }
  if (lastLog.clockOut) {
    html += "<b>Last Time Out:</b> " + new Date(lastLog.clockOut).toLocaleString();
  }
  lastDiv.innerHTML = html;
}

async function getOjtLogs(userId = null) {
  userId = userId || localStorage.getItem("currentUserId");
  if (!userId) return [];
  const res = await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/ojtlogs/${userId}`);
  if (!res.ok) return [];
  return await res.json();
}

async function clockOutBackend() {
  const userId = localStorage.getItem("currentUserId");
  const logs = await getOjtLogs();
  // Find the latest log with a clockIn but no clockOut
  const lastLog = logs.find(log => log.clockIn && !log.clockOut);
  if (!lastLog) return false;
  const now = new Date().toISOString();
  const res = await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/ojtlogs/${lastLog.id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ clockOut: now })
  });
  return res.ok;
}

async function clockInBackend(photoData) {
  const userId = localStorage.getItem("currentUserId");
  const now = new Date().toISOString();
  const res = await fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/ojtlogs', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ userId, clockIn: now, photo: photoData })
  });
  return res.ok ? await res.json() : null;
}

function renderAllClockRecords() {
  const { logs } = getUserLogs();
  const container = document.getElementById('allRecords');
  if (!container) return;
  if (!logs || logs.length === 0) {
    container.innerHTML = "<p>No records yet.</p>";
    return;
  }
  let html = "<table border='1'><tr><th>#</th><th>Time In</th><th>Time Out</th><th>Photo</th></tr>";
  logs.forEach((log, idx) => {
    html += `<tr>
      <td>${idx + 1}</td>
      <td>${log.clockIn ? new Date(log.clockIn).toLocaleString() : "-"}</td>
      <td>${log.clockOut ? new Date(log.clockOut).toLocaleString() : "-"}</td>
      <td>${log.photo ? `<img src="${log.photo}" width="80"/>` : "-"}</td>
    </tr>`;
  });
  html += "</table>";
  container.innerHTML = html;
}

document.addEventListener("DOMContentLoaded", function() {
  renderLastClockRecord(); // Shows the last clock in/out
  renderClockTabRecords();
});

async function renderClockTabRecords() {
  const logs = await getOjtLogs();
  const container = document.getElementById('clockRecords');
  if (!container) return;
  if (!logs || logs.length === 0) {
    container.innerHTML = "<p>No records yet.</p>";
    return;
  }
  // Group logs by date
  const grouped = {};
  logs.forEach(log => {
    const dateStr = new Date(log.clockIn).toLocaleDateString();
    if (!grouped[dateStr]) grouped[dateStr] = [];
    grouped[dateStr].push(log);
  });

  let html = `<h2 style="color:#25a55f;">Time In/Out Records:</h2>`;
  for (const [date, group] of Object.entries(grouped)) {
    html += `<div style="margin-top:1em;">
      <span style="font-weight:bold;color:#25a55f;">${date}</span><br>`;
    group.forEach(log => {
      html += `<div style="margin-left:1.5em;margin-bottom:0.8em;">
        <span> Time In: ${log.clockIn ? new Date(log.clockIn).toLocaleString() : "-"}</span><br>
        ${log.photo ? `<img src="${log.photo}" width="120" style="margin:6px 0;border-radius:6px;border:1px solid #ccc;"/><br>` : ""}
        ${log.clockOut ? `<span> Time Out: ${new Date(log.clockOut).toLocaleString()}</span><br>` : ""}
      </div>`;
    });
    html += `</div>`;
  }
  container.innerHTML = html;
}

// --- Fetch all daily logs for the user ---
async function getDailyLogs() {
  const userId = getCurrentUserId();
  if (!userId) return [];
  const res = await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/dailylogs/${userId}`);
  if (!res.ok) return [];
  return await res.json();
}

// --- Save a new daily log ---
async function saveDailyLog(logObj) {
  const res = await fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/dailylogs', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(logObj)
  });
  return await res.json();
}

// --- Delete a log ---
async function deleteDailyLog(logId) {
  await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/dailylogs/${logId}`, { method: 'DELETE' });
}

// --- Update a log (edit) ---
async function updateDailyLog(logId, logObj) {
  await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/dailylogs/${logId}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(logObj)
  });
}

// --- Render logs ---
async function renderDailyLogs() {
  const logs = await getDailyLogs();
  const logsList = document.getElementById('dailyLogsList');
  if (!logsList) return;
  if (logs.length === 0) {
    logsList.innerHTML = "<p style='color:#888;text-align:center;'>No logs yet.</p>";
    return;
  }

  logsList.innerHTML = logs.map((log) => {
    const logId = `userlog-${log.id}`;
    return `
    <div style="background:#f8f8f8;border-radius:1em;padding:1em;margin-bottom:1.6em;box-shadow:0 1px 6px #0001;position:relative;">
      <div style="position:absolute;top:14px;right:18px;">
        <button class="menu-btn" onclick="toggleDailyLogMenu(${log.id}, event)" style="background:none;border:none;cursor:pointer;font-size:1.5em;padding:0 7px;">&#x22EE;</button>
        <div id="daily-log-menu-${log.id}" class="comment-menu" style="display:none;position:absolute;right:0;top:28px;min-width:90px;background:#fff;border:1px solid #e0e0e0;box-shadow:0 2px 10px #0003;border-radius:8px;z-index:1000;">
          <div onclick="editUserDailyLog(${log.id})" style="padding:10px 18px;cursor:pointer;font-size:1.01em;border-bottom:1px solid #eee;">Edit</div>
          <div onclick="deleteUserDailyLog(${log.id})" style="padding:10px 18px;cursor:pointer;font-size:1.01em;color:#e74c3c;">Delete</div>
        </div>
      </div>
      <span style="color:#2299ee;font-size:0.95em;">${new Date(log.date).toLocaleString()}</span>
      <h3 style="margin:0.3em 0 0.4em 0;font-size:1.15em;color:#25a55f;">${log.title}</h3>
      <p style="margin:0.2em 0 0.7em 0;color:#333;">${log.desc}</p>
      <img src="${log.img}" alt="Uploaded activity" style="max-width:100%;border-radius:0.7em;border:1px solid #ccc;box-shadow:0 1px 3px #0002;">
      <div style="margin-top:10px;">
        <b style="color:#2299ee;">Comments</b>
        <div id="comments-userlog-${log.id}">
          ${Array.isArray(log.comments) && log.comments.length ? 
            log.comments.map((comment, ci) => `
              <div style="margin:7px 0 7px 0;padding:8px 12px;background:#f3f3f3;border-radius:7px;position:relative;">
                <span style="color:#11695c;font-weight:500;">${comment.by || 'You'}</span>
                <span style="color:#888;font-size:.97em;margin-left:6px;">${new Date(comment.timestamp).toLocaleString()}</span>
                <div style="margin-top:3px;color:#222;">${comment.text}</div>
                <div style="position:absolute;top:8px;right:16px;">
                  <button class="menu-btn" onclick="toggleLogCommentMenu(${log.id},${ci},event)" style="background:none;border:none;cursor:pointer;font-size:1.5em;padding:0 7px;">&#x22EE;</button>
                  <div id="log-comment-menu-${log.id}-${ci}" class="comment-menu" style="display:none;position:absolute;right:0;top:28px;min-width:75px;background:#fff;border:1px solid #e0e0e0;box-shadow:0 2px 10px #0003;border-radius:8px;z-index:1000;">
                    <div onclick="editStudentActivityComment(${log.id},${ci})" style="padding:8px 15px;cursor:pointer;font-size:0.97em;border-bottom:1px solid #eee;">Edit</div>
                    <div onclick="deleteStudentActivityComment(${log.id},${ci})" style="padding:8px 15px;cursor:pointer;font-size:0.97em;color:#e74c3c;">Delete</div>
                  </div>
                </div>
              </div>
            `).join('') : '<div style="color:#aaa;font-size:.97em;">No comments yet.</div>'}
          <form onsubmit="addCommentToUserPost(event, ${log.id})" style="margin-top:8px;display:flex;gap:7px;">
            <input type="text" name="comment" placeholder="Write a comment..." style="flex:1;padding:7px 10px;border-radius:7px;border:1px solid #b2dfdb;font-size:1em;" required>
            <button type="submit" style="padding:7px 18px;border-radius:7px;background:linear-gradient(90deg,#2299ee,#25a55f);color:#fff;border:none;font-weight:600;cursor:pointer;">Post</button>
          </form>
        </div>
      </div>
    </div>
    `;
  }).join('');
}

function toggleDailyLogMenu(logId, event) {
  event.stopPropagation();
  document.querySelectorAll('.comment-menu').forEach(menu => menu.style.display = 'none');
  const menu = document.getElementById(`daily-log-menu-${logId}`);
  if (menu) menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
}
function toggleLogCommentMenu(logId, ci, event) {
  event.stopPropagation();
  document.querySelectorAll('.comment-menu').forEach(menu => menu.style.display = 'none');
  const menu = document.getElementById(`log-comment-menu-${logId}-${ci}`);
  if (menu) menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
}
// Hide all menus if clicking outside
window.addEventListener('click', function() {
  document.querySelectorAll('.comment-menu').forEach(menu => menu.style.display = 'none');
});

function editStudentActivityComment(logId, commentIndex) {
  // Get the logs from your source (replace with your actual logic!)
  getDailyLogs().then(logs => {
    const log = logs.find(l => l.id === logId);
    if (!log || !log.comments || !log.comments[commentIndex]) {
      alert("Comment not found.");
      return;
    }
    const comment = log.comments[commentIndex];
    const newText = prompt("Edit your comment:", comment.text);
    if (newText !== null && newText.trim() !== "") {
      // TODO: update comment text in backend API, then refresh logs
      fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/dailylogs/${logId}/comments/${commentIndex}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: newText.trim() })
      }).then(() => renderDailyLogs());
    }
  });
}
window.editStudentActivityComment = editStudentActivityComment;

function deleteStudentActivityComment(logId, commentIndex) {
  if (!confirm("Delete this comment?")) return;
  // TODO: delete comment in backend, then refresh logs
  fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/dailylogs/${logId}/comments/${commentIndex}`, {
    method: 'DELETE'
  }).then(() => renderDailyLogs());
}
window.deleteStudentActivityComment = deleteStudentActivityComment;


document.getElementById('dailyLogForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const title = document.getElementById('logTitle').value.trim();
  const desc = document.getElementById('logDesc').value.trim();
  const fileInput = document.getElementById('logImg');
  const userIdRaw = localStorage.getItem('currentUserId');
  // If userId is string number, convert to number; if absent use null
  const userId = userIdRaw && !isNaN(Number(userIdRaw)) ? Number(userIdRaw) : null;

  if (!title || !desc || !fileInput.files.length) {
    alert('Please fill in all fields and upload an image.');
    return;
  }

  if (!userId) {
    // You can decide to block or allow 'guest' logs; here we require login
    if (!confirm('You are not logged in as a user. Save as local draft instead?')) return;
    // If user chooses, fallback to localStorage-only behaviour
  }

  const reader = new FileReader();
  reader.onload = async function(ev) {
    const logObj = {
      userId, // number or null
      date: new Date().toISOString(),
      title,
      desc,
      img: ev.target.result,
      comments: []
    };

    // Try POSTing to backend
    try {
      const res = await fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/dailylogs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(logObj)
      });
      if (res.ok) {
        // saved on server; refresh UI
        document.getElementById('dailyLogForm').reset();
        // re-render logs from server
        renderDailyLogs();
        alert('Daily log saved.');
      } else {
        const err = await res.json().catch(() => ({}));
        alert('Failed to save daily log: ' + (err.error || 'Server returned error'));
        // fallback: save locally
        saveDailyLogLocally(userId, logObj);
      }
    } catch (error) {
      console.error('Network/save error:', error);
      alert('Network error while saving log - saved locally as draft.');
      saveDailyLogLocally(userId, logObj);
    }
  };
  reader.readAsDataURL(fileInput.files[0]);
});

function saveDailyLogLocally(userId, logObj) {
  let allLogs = JSON.parse(localStorage.getItem('dailyLogs') || '{}');
  const uidKey = userId ? String(userId) : 'guest';
  if (!allLogs[uidKey]) allLogs[uidKey] = [];
  allLogs[uidKey].push(logObj);
  localStorage.setItem('dailyLogs', JSON.stringify(allLogs));
  document.getElementById('dailyLogForm').reset();
  renderDailyLogs();
}

// --- Show/hide post menu ---
function showUserPostOptionsMenu(e, logId) {
  e.stopPropagation();
  document.querySelectorAll('.post-options-menu').forEach(menu => menu.style.display = 'none');
  var menu = document.getElementById('post-options-menu-' + logId);
  if (menu) menu.style.display = (menu.style.display === 'block' ? 'none' : 'block');
}
document.addEventListener('click', function() {
  document.querySelectorAll('.post-options-menu').forEach(menu => menu.style.display = 'none');
});

// --- Delete log handler ---
async function deleteUserDailyLog(id) {
  if (!confirm("Delete this log?")) return;
  await deleteDailyLog(id);
  renderDailyLogs();
}
window.deleteUserDailyLog = deleteUserDailyLog;

// --- Edit log handler ---
async function editUserDailyLog(id) {
  const logs = await getDailyLogs();
  const post = logs.find(l => l.id === id);
  if (!post) return alert("Log not found.");
  const newTitle = prompt("Edit Title:", post.title);
  if (newTitle === null) return;
  const newDesc = prompt("Edit Description:", post.desc);
  if (newDesc === null) return;
  post.title = newTitle;
  post.desc = newDesc;
  await updateDailyLog(id, post);
  renderDailyLogs();
}
window.editUserDailyLog = editUserDailyLog;

async function addCommentToUserPost(e, logId) {
  e.preventDefault();
  const logs = await getDailyLogs();
  const post = logs.find(l => l.id === logId);
  if (!post) return;
  const commentText = e.target.comment.value.trim();
  if (!commentText) return;
  post.comments = Array.isArray(post.comments) ? post.comments : [];
  post.comments.push({
    text: commentText,
    by: "You",
    timestamp: new Date().toISOString()
  });
  await updateDailyLog(logId, post);
  renderDailyLogs();
}
window.addCommentToUserPost = addCommentToUserPost;

// --- Render logs on page load ---
document.addEventListener('DOMContentLoaded', renderDailyLogs);

// Edit daily log comment
async function editDailyLogComment(logId, commentIdx) {
  const res = await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/dailylogs`);
  if (!res.ok) return alert("Failed to load daily logs.");
  const logs = await res.json();
  const log = logs.find(l => String(l.id) === String(logId));
  if (!log) return alert("Log not found.");

  const comment = log.comments?.[commentIdx];
  if (!comment) return alert("Comment not found.");

  const newText = prompt("Edit comment:", comment.text);
  if (newText !== null && newText.trim() !== "") {
    log.comments[commentIdx].text = newText.trim();
    // Save to backend
    await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/dailylogs/${logId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        title: log.title,
        desc: log.desc,
        img: log.img,
        comments: log.comments
      })
    });
    await renderDailyLogs(); // Refresh display
  }
}
window.editDailyLogComment = editDailyLogComment;

// Delete daily log comment
async function deleteDailyLogComment(logId, commentIdx) {
  if (!confirm("Delete this comment?")) return;
  const res = await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/dailylogs`);
  if (!res.ok) return alert("Failed to load daily logs.");
  const logs = await res.json();
  const log = logs.find(l => String(l.id) === String(logId));
  if (!log) return alert("Log not found.");
  if (!Array.isArray(log.comments) || typeof commentIdx !== 'number' || commentIdx < 0 || commentIdx >= log.comments.length) {
    return alert("Comment not found.");
  }
  log.comments.splice(commentIdx, 1);
  // Save to backend
  await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/dailylogs/${logId}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      title: log.title,
      desc: log.desc,
      img: log.img,
      comments: log.comments
    })
  });
  await renderDailyLogs();
}
window.deleteDailyLogComment = deleteDailyLogComment;

// Utility for user requirements
function getCurrentUserId() {
  return localStorage.getItem('currentUserId') || 'guest';
}

function getUserRequirements() {
  const allReqs = JSON.parse(localStorage.getItem('userRequirements') || '{}');
  return allReqs[getCurrentUserId()] || {};
}

function saveUserRequirements(reqObj) {
  const allReqs = JSON.parse(localStorage.getItem('userRequirements') || '{}');
  allReqs[getCurrentUserId()] = reqObj;
  localStorage.setItem('userRequirements', JSON.stringify(allReqs));
}

// Render uploaded requirements (for status/preview)
async function renderRequirementsStatus() {
  const studentId = localStorage.getItem('currentUserId');
  const res = await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/requirements/${studentId}`);
  if (!res.ok) return;
  const files = await res.json();
  const uploadedTypes = new Set(files.map(f => f.type.toLowerCase()));
  // Update checkboxes to reflect upload status
  reqTypes.forEach(({id}) => {
    const chk = document.getElementById('chk' + id);
    if (chk) chk.checked = uploadedTypes.has(id.toLowerCase());
  });
  // Build status HTML
  const statusDiv = document.getElementById('requirementsStatus');
  if (!statusDiv) return;
  let html = `<h3 style="margin-top:0;color:#2299ee;font-size:1.04em;">Your Uploaded Files:</h3>`;
  reqTypes.forEach(({id, label}) => {
    const file = files.find(f => f.type.toLowerCase() === id.toLowerCase());
    if (file) {
      const fileUrl = `https://slsu-ojt-monitoring-system-1.onrender.com/requirements/${file.filename}`;
      html += `<div style="margin-bottom:6px;">
        <input type="checkbox" checked readonly style="margin-right:6px;">
        <b>${label}</b>
        <a href="${fileUrl}" target="_blank" style="color:#2299ee;margin-left:10px;">View/Download</a>
      </div>`;
    } else {
      html += `<div style="margin-bottom:6px;">
        <input type="checkbox" readonly style="margin-right:6px;">
        <b>${label}</b>
        <span style="color:#bbb;margin-left:10px;">Not uploaded</span>
      </div>`;
    }
  });
  statusDiv.innerHTML = html;
}
document.addEventListener('DOMContentLoaded', renderRequirementsStatus);

function getReqTypeLabel(type) {
  return {
    medical: 'Medical Certificate',
    waiver: 'Waiver',
    internApp: "STUDENT INTERNS Application Form",
    contract: 'INTERNSHIP CONTRACT/AGREEMENT',
    acceptance: 'INTERNSHIP ACCEPTANCE LETTER',
    resume: 'Resume',
    endorsement: 'Endorsement Letter',
    moa: 'MOA',
    idpic: '2x2 ID Picture',
    insurance: 'INSURANCE'
  }[type] || type;
}

document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('requirementsForm');
  const submitBtn = form ? form.querySelector('button[type="submit"]') : null;

  if (!form) return;

  form.addEventListener('submit', async function (e) {
    e.preventDefault();

    const studentIdRaw = localStorage.getItem('currentUserId');
    const studentId = studentIdRaw && !isNaN(Number(studentIdRaw)) ? String(studentIdRaw) : null;

    if (!studentId) {
      if (!confirm('You are not logged in. Upload will be aborted.')) return;
    }

    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.textContent = 'Uploading...';
    }

    let uploaded = 0;
    let failed = 0;
    const results = [];

    for (const { id } of reqTypes) {
      const input = document.getElementById('req' + id);
      if (!input || !input.files || input.files.length === 0) continue;

      const file = input.files[0];
      const type = id.toLowerCase(); // use lowercase type names in DB

      const fd = new FormData();
      fd.append('file', file);
      fd.append('studentId', studentId || 'guest');
      fd.append('type', type);

      try {
        const resp = await fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/requirements', {
          method: 'POST',
          body: fd
        });

        const body = await resp.json().catch(() => ({}));

        if (resp.ok) {
          uploaded++;
          results.push({ type, file: file.name, ok: true, response: body });
        } else {
          failed++;
          results.push({ type, file: file.name, ok: false, status: resp.status, response: body });
        }
      } catch (err) {
        failed++;
        results.push({ type, file: file.name, ok: false, error: err.message });
      }
    }

    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Requirements';
    }

    console.log('Requirements upload summary', { uploaded, failed, results });

    if (uploaded > 0) {
      // refresh student UI
      if (typeof renderRequirementsStatus === 'function') {
        try { await renderRequirementsStatus(); } catch (e) { console.warn('renderRequirementsStatus failed', e); }
      }

      // notify admin tabs (use studentId if available)
      try {
        if (typeof notifyRequirementsUpdated === 'function') {
          await notifyRequirementsUpdated(studentId || (results[0] && results[0].response && results[0].response.studentId) || null);
        }
      } catch (e) {
        console.warn('notifyRequirementsUpdated failed', e);
      }

      alert(`${uploaded} file(s) uploaded successfully.`);
      form.reset(); // clear inputs
      // re-run filename/check UI initializer if you need immediate updates (optional)
      // e.g. call code that updates filename spans and checkboxes
      if (typeof initRequirementsFileUI === 'function') initRequirementsFileUI();
    } else if (failed > 0) {
      alert(`Upload failed for ${failed} file(s). See console for details.`);
    } else {
      alert('No files selected for upload.');
    }
  });
});

const bc = (typeof BroadcastChannel !== 'undefined') ? new BroadcastChannel('slsu-internship-updates') : null;


document.addEventListener('DOMContentLoaded', () => {
  // Find all file inputs inside the requirements form
  const fileInputs = document.querySelectorAll('#requirementsForm input[type="file"]');

  fileInputs.forEach(input => {
    // Derive checkbox id from file input id: reqResume -> chkResume
    const checkboxId = input.id.replace(/^req/, 'chk');
    const chk = document.getElementById(checkboxId);

    // Update checkbox immediately on load (if a file is already chosen)
    if (chk) chk.checked = !!(input.files && input.files.length);

    // When user selects a file, toggle the checkbox
    input.addEventListener('change', () => {
      if (chk) chk.checked = !!(input.files && input.files.length);
    });
  });
});


// Utility to notify other tabs / admin UI
async function notifyRequirementsUpdated(studentId) {
  console.log('[Broadcast] requirements-updated for studentId=', studentId);
  if (bc) {
    bc.postMessage({ type: 'requirements-updated', studentId });
  }
  // If admin UI present in this same page, refresh it
  if (typeof renderAdminRequirements === 'function') {
    // call it asynchronously so UI stays responsive
    try {
      await renderAdminRequirements();
    } catch (err) {
      console.warn('renderAdminRequirements() failed after upload:', err);
    }
  }
}

// Listen for notifications (admin or other tabs)
if (bc) {
  bc.onmessage = (ev) => {
    try {
      const msg = ev.data;
      if (msg && msg.type === 'requirements-updated') {
        console.log('[Broadcast] Received requirements-updated', msg);
        // If this page has the admin requirements area, refresh it
        if (typeof renderAdminRequirements === 'function') {
          renderAdminRequirements().catch(err => console.warn('renderAdminRequirements error:', err));
        }
      }
    } catch (e) {
      console.warn('BroadcastChannel message handler error', e);
    }
  };
}

async function onUploadSuccessForStudent(studentId) {
  await notifyRequirementsUpdated(studentId);
  console.log('Notified admin UI about new requirements for student', studentId);
}

// Utility for user FAQ
function getCurrentUserId() {
  return localStorage.getItem('currentUserId') || 'guest';
}

async function getFaqs() {
  const res = await fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/faqs');
  if (!res.ok) return [];
  return await res.json();
}

async function saveFaq(faqObj) {
  const res = await fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/faqs', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(faqObj)
  });
  return await res.json();
}

async function updateFaqComments(faqId, comments) {
  await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/faqs/${faqId}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ comments })
  });
}

async function renderFaqs() {
  const faqs = await getFaqs();
  const faqsList = document.getElementById('faqsList');
  if (!faqsList) return;

  // Get the currently logged in user's ID
  const currentUserId = localStorage.getItem('currentUserId');

  // Filter FAQs to only those posted by the current user
  const userFaqs = faqs.filter(faq => String(faq.userId) === String(currentUserId));

  if (userFaqs.length === 0) {
    faqsList.innerHTML = "<p style='color:#888;text-align:center;'>No questions yet.</p>";
    return;
  }

  faqsList.innerHTML = userFaqs.map((faq, idx) => `
    <div style="background:#f8f8f8;border-radius:1em;padding:1em;margin-bottom:1.6em;box-shadow:0 1px 6px #0001;position:relative;">
      <div style="position:absolute;top:14px;right:18px;">
  <button class="menu-btn" onclick="toggleFaqPostMenu(${faq.id}, event)" style="background:none;border:none;cursor:pointer;font-size:1.5em;padding:0 7px;">&#x22EE;</button>
  <div id="faq-post-menu-${faq.id}" class="comment-menu" style="display:none;position:absolute;right:0;top:28px;min-width:90px;background:#fff;border:1px solid #e0e0e0;box-shadow:0 2px 10px #0003;border-radius:8px;z-index:1000;">
    <div onclick="editStudentFaqPost(${faq.id})" style="padding:10px 18px;cursor:pointer;font-size:1.01em;border-bottom:1px solid #eee;">Edit</div>
    <div onclick="deleteStudentFaqPost(${faq.id})" style="padding:10px 18px;cursor:pointer;font-size:1.01em;color:#e74c3c;">Delete</div>
  </div>
</div>
      <div style="font-size:.96em;color:#2299ee;font-weight:500;">${faq.userName || "Anonymous"}</div>
      <div style="color:#999;font-size:.95em;margin-bottom:0.3em;">${new Date(faq.date).toLocaleString()}</div>
      <div style="margin-bottom:.8em;font-size:1.11em;color:#11695c;">${faq.question}</div>
      ${faq.img ? `<img src="${faq.img}" alt="faq-img" style="max-width:160px;border-radius:0.7em;border:1px solid #ccc;box-shadow:0 1px 3px #0002;margin-bottom:10px;">` : ""}
      <div>
        <b style="color:#2299ee;">Comments</b>
        <div id="faq-comments-${faq.id}">
${Array.isArray(faq.comments) && faq.comments.length ?
  faq.comments.map((comment, ci) => `
        <div style="margin:7px 0 7px 0;padding:8px 12px;background:#eafaf5;border-radius:7px;position:relative;">
          <span style="color:#11695c;font-weight:500;">${comment.by || 'You'}</span>
          <span style="color:#888;font-size:.97em;margin-left:6px;">${new Date(comment.timestamp).toLocaleString()}</span>
          <div style="margin-top:3px;color:#222;">${comment.text}</div>
          <div style="position:absolute;top:8px;right:16px;">
  <button class="menu-btn" onclick="toggleFaqCommentMenu(${faq.id},${ci},event)" style="background:none;border:none;cursor:pointer;font-size:1.5em;padding:0 7px;">&#x22EE;</button>
  <div id="faq-comment-menu-${faq.id}-${ci}" class="comment-menu" style="display:none;position:absolute;right:0;top:28px;min-width:90px;background:#fff;border:1px solid #e0e0e0;box-shadow:0 2px 10px #0003;border-radius:8px;z-index:1000;">
    <div onclick="editStudentFaqComment(${faq.id},${ci})" style="padding:10px 18px;cursor:pointer;font-size:1.01em;border-bottom:1px solid #eee;">Edit</div>
    <div onclick="deleteStudentFaqComment(${faq.id},${ci})" style="padding:10px 18px;cursor:pointer;font-size:1.01em;color:#e74c3c;">Delete</div>
  </div>
</div>
      `).join('')
  : '<div style="color:#aaa;font-size:.97em;">No comments yet.</div>'}
        </div>
        <form onsubmit="addCommentToFaq(event, ${faq.id})" style="margin-top:8px;display:flex;gap:7px;">
          <input type="text" name="comment" placeholder="Write a comment..." style="flex:1;padding:7px 10px;border-radius:7px;border:1px solid #b2dfdb;font-size:1em;" required>
          <button type="submit" style="padding:7px 18px;border-radius:7px;background:linear-gradient(90deg,#2299ee,#25a55f);color:#fff;border:none;font-weight:600;cursor:pointer;">Post</button>
        </form>
      </div>
    </div>
  `).join('');
}

function toggleFaqCommentMenu(faqId, ci, event) {
  event.stopPropagation();
  document.querySelectorAll('.comment-menu').forEach(menu => menu.style.display = 'none');
  const menu = document.getElementById(`faq-comment-menu-${faqId}-${ci}`);
  if (menu) menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
}
window.addEventListener('click', function() {
  document.querySelectorAll('.comment-menu').forEach(menu => menu.style.display = 'none');
});

function toggleFaqPostMenu(faqId, event) {
  event.stopPropagation();
  // Hide all open menus
  document.querySelectorAll('.comment-menu').forEach(menu => menu.style.display = 'none');
  // Show the target menu
  const menu = document.getElementById(`faq-post-menu-${faqId}`);
  if (menu) menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
}
// Hide menu when clicking outside
window.addEventListener('click', function() {
  document.querySelectorAll('.comment-menu').forEach(menu => menu.style.display = 'none');
});

// Edit FAQ post (student)
async function editStudentFaqPost(faqId) {
  const res = await fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/faqs');
  if (!res.ok) return alert('Failed to load FAQs.');
  const faqs = await res.json();
  const faq = faqs.find(f => String(f.id) === String(faqId));
  if (!faq) return alert('FAQ not found.');

  // Only allow FAQ authors to edit
  if (String(faq.userId) !== String(localStorage.getItem('currentUserId'))) {
    return alert("You can only edit your own FAQ post.");
  }

  const newQuestion = prompt("Edit your FAQ question:", faq.question);
  if (newQuestion !== null && newQuestion.trim() !== "") {
    await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/faqs/${faqId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        question: newQuestion.trim(),
        comments: faq.comments,
        img: faq.img,
        userName: faq.userName,
        date: faq.date,
        userId: faq.userId
      })
    });
    if (typeof renderFaqs === "function") await renderFaqs();
  }
}
window.editStudentFaqPost = editStudentFaqPost;

// Delete FAQ post (student)
async function deleteStudentFaqPost(faqId) {
  const res = await fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/faqs');
  if (!res.ok) return alert('Failed to load FAQs.');
  const faqs = await res.json();
  const faq = faqs.find(f => String(f.id) === String(faqId));
  if (!faq) return alert('FAQ not found.');
  // Only allow FAQ authors to delete
  if (String(faq.userId) !== String(localStorage.getItem('currentUserId'))) {
    return alert("You can only delete your own FAQ post.");
  }
  if (!confirm("Delete your FAQ post (and all its comments)?")) return;

  await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/faqs/${faqId}`, { method: "DELETE" });
  if (typeof renderFaqs === "function") await renderFaqs();
}
window.deleteStudentFaqPost = deleteStudentFaqPost;

// Edit student's FAQ comment
async function editStudentFaqComment(faqId, commentIdx) {
  const res = await fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/faqs');
  if (!res.ok) return alert("Failed to load FAQs.");
  const faqs = await res.json();
  const faq = faqs.find(f => String(f.id) === String(faqId));
  if (!faq) return alert("FAQ not found.");
  const comment = faq.comments?.[commentIdx];
  if (!comment) return alert("Comment not found.");

  // Optionally: Only allow the owner to edit their comment
  const currentUser = localStorage.getItem('currentUserName') || "";
  if (comment.by !== currentUser) {
    return alert('You can only edit your own comments.');
  }

  const newText = prompt("Edit your comment:", comment.text);
  if (newText !== null && newText.trim() !== "") {
    faq.comments[commentIdx].text = newText.trim();
    await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/faqs/${faqId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ comments: faq.comments })
    });
    await renderFaqs();
  }
}
window.editStudentFaqComment = editStudentFaqComment;

// Delete student's FAQ comment
async function deleteStudentFaqComment(faqId, commentIdx) {
  const res = await fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/faqs');
  if (!res.ok) return alert("Failed to load FAQs.");
  const faqs = await res.json();
  const faq = faqs.find(f => String(f.id) === String(faqId));
  if (!faq) return alert("FAQ not found.");
  if (!Array.isArray(faq.comments) || typeof commentIdx !== 'number' || commentIdx < 0 || commentIdx >= faq.comments.length) {
    return alert("Comment not found.");
  }

  // Optionally: Only allow the owner to delete their comment
  const currentUser = localStorage.getItem('currentUserName') || "";
  if (faq.comments[commentIdx].by !== currentUser) {
    return alert('You can only delete your own comments.');
  }

  if (!confirm("Delete this comment?")) return;
  faq.comments.splice(commentIdx, 1);
  await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/faqs/${faqId}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ comments: faq.comments })
  });
  await renderFaqs();
}
window.deleteStudentFaqComment = deleteStudentFaqComment;

document.addEventListener('DOMContentLoaded', () => {
  const faqForm = document.getElementById('faqForm');
  if (!faqForm) {
    console.warn('FAQ form (#faqForm) not found');
    return;
  }

  faqForm.addEventListener('submit', async function (e) {
    e.preventDefault();
    try {
      const questionEl = document.getElementById('faqQuestion');
      const imgInput = document.getElementById('faqImg');
      const question = questionEl && questionEl.value ? questionEl.value.trim() : '';
      if (!question) {
        alert('Please enter a question before posting.');
        return;
      }

      // Build object to send to server (img optional -> base64)
      const faqObj = {
        userId: localStorage.getItem('currentUserId') || null,
        userName: localStorage.getItem('currentUserName') || 'Anonymous',
        date: new Date().toISOString(),
        question,
        img: "",
        comments: []
      };

      // show immediate UI feedback
      const submitBtn = faqForm.querySelector('button[type="submit"]');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Posting...';
      }

      if (imgInput && imgInput.files && imgInput.files[0]) {
        // read file as data URL before sending
        const file = imgInput.files[0];
        const reader = new FileReader();
        const dataUrl = await new Promise((resolve, reject) => {
          reader.onerror = () => reject(new Error('Failed to read image file'));
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(file);
        });
        faqObj.img = dataUrl;
      }

      console.log('[FAQ] Sending to /api/faqs:', faqObj);

      // POST to backend
      const res = await fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/faqs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(faqObj)
      });

      const text = await res.text();
      let body;
      try { body = JSON.parse(text); } catch (err) { body = { raw: text }; }

      console.log('[FAQ] Response status:', res.status, 'body:', body);

      if (!res.ok) {
        // show server error to user
        const msg = (body && body.error) ? body.error : `Server returned ${res.status}`;
        alert('Failed to post question: ' + msg);
        if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Post Question'; }
        return;
      }

      // success  reset UI and re-render list
      if (faqForm) faqForm.reset();
      alert('Question posted successfully.');

      // re-render faqs (you already have renderFaqs)
      if (typeof renderFaqs === 'function') {
        try { await renderFaqs(); } catch (err) { console.warn('renderFaqs failed after post:', err); }
      }

      if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Post Question'; }
    } catch (err) {
      console.error('[FAQ] Unexpected error posting question:', err);
      alert('Unexpected error posting question: ' + (err && err.message ? err.message : String(err)));
      const submitBtn = faqForm.querySelector('button[type="submit"]');
      if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Post Question'; }
    }
  });
});

async function addCommentToFaq(e, faqId) {
  e.preventDefault();
  const faqs = await getFaqs();
  const faq = faqs.find(f => f.id === faqId);
  if (!faq) return;
  const commentText = e.target.comment.value.trim();
  if (!commentText) return;
  faq.comments = Array.isArray(faq.comments) ? faq.comments : [];
  faq.comments.push({
    text: commentText,
    by: localStorage.getItem('currentUserName') || "User",
    timestamp: new Date().toISOString()
  });
  await updateFaqComments(faqId, faq.comments);
  renderFaqs();
}
window.addCommentToFaq = addCommentToFaq;

// On page load, fetch and render FAQs
document.addEventListener('DOMContentLoaded', renderFaqs);

async function renderUserOjtOverview() {
  const userId = localStorage.getItem('currentUserId') || '';
  if (!userId) return;

  // Get student and class info (can keep using localStorage for user/class info)
  const students = JSON.parse(localStorage.getItem('students') || "[]");
  const user = students.find(u => u.id == userId);
  let totalOjt = 0;
  if (user && user.dept) {
    let classes = JSON.parse(localStorage.getItem("classes") || "[]");
    let userClass = classes.find(c => c.course === user.dept);
    if (userClass) {
      totalOjt = parseInt(userClass.hours || 0);
    }
  }
  if (totalOjt === 0) totalOjt = 300; // fallback default

  // Fetch OJT logs from backend
  const logs = await getOjtLogs(userId);
  let completed = 0;
  logs.forEach(log => {
    if (log.clockIn && log.clockOut) {
      let t1 = new Date(log.clockIn).getTime();
      let t2 = new Date(log.clockOut).getTime();
      if (t2 > t1) completed += (t2 - t1) / (1000 * 60 * 60); // hours
    }
  });
  completed = Math.round(completed * 100) / 100;
  let remaining = Math.max(0, Math.round((totalOjt - completed) * 100) / 100);

  // Render
  document.getElementById('userOjtOverview').innerHTML = `
    <div style="background:#f6fff7;border-radius:1.3em;padding:1.7em;max-width:420px;margin:26px auto 0;box-shadow:0 2px 18px #0002;">
      <div style="font-size:1.2em;color:#11695c;margin-bottom:1.4em;text-align:center;">
        <b>Total OJT Hours Required:</b> ${totalOjt}
      </div>
      <div style="font-size:1.15em;color:#2299ee;margin-bottom:0.8em;text-align:center;">
        <b>Hours Completed:</b> ${completed}
      </div>
      <div style="font-size:1.13em;color:#e67e22;text-align:center;">
        <b>Hours Remaining:</b> ${remaining}
      </div>
      <div style="margin-top:2em;">
        <b>Time In/Out Records:</b>
        <ul style="margin:10px 0 0 0;padding:0;list-style:none;max-height:180px;overflow:auto;">
          ${logs.length === 0 ? '<li style="color:#bbb;">No records yet.</li>' :
            logs.slice().reverse().map(log => `
              <li style="margin-bottom:8px;font-size:.98em;">
                <span style="color:#25a55f;">${log.clockIn ? new Date(log.clockIn).toLocaleString() : '-'}</span>
                &rarr; 
                <span style="color:#e74c3c;">${log.clockOut ? new Date(log.clockOut).toLocaleString() : '-'}</span>
                ${log.clockIn && log.clockOut ? `<span style="color:#888;margin-left:8px;">(${((new Date(log.clockOut)-new Date(log.clockIn))/3600000).toFixed(2)} hrs)</span>` : ""}
              </li>
            `).join('')}
        </ul>
      </div>
    </div>
  `;
}

async function generateUserReport() {
  const range = document.getElementById('userReportRange').value;
  const userId = localStorage.getItem('currentUserId');
  if (!userId) {
    document.getElementById('userReportResult').innerHTML = '<div style="color:#e74c3c;">No user logged in.</div>';
    return;
  }
  const students = JSON.parse(localStorage.getItem('students') || "[]");
  const user = students.find(s => s.id === userId);

  let html = `<h3>Report for ${user ? `${user.last}, ${user.first} (${user.studid || user.id})` : 'This User'}</h3>`;

  // 1. Clock In/Out Records
  const clockLogs = await getOjtLogs(userId);
  html += `<h4>Time In/Out Records</h4>`;
  if (clockLogs.length > 0) {
    html += `<ul style="margin:0 0 1em 1em;">`;
    clockLogs.forEach(log => {
      html += `<li>
        <b>In:</b> ${log.clockIn ? new Date(log.clockIn).toLocaleString() : "-"}
        &nbsp; <b>Out:</b> ${log.clockOut ? new Date(log.clockOut).toLocaleString() : "-"}
        ${log.photo ? `<br><img src="${log.photo}" alt="Time-in photo" style="max-width:120px;max-height:100px;margin:5px 0;border-radius:8px;border:1px solid #ccc;">` : ""}
      </li>`;
    });
    html += `</ul>`;
  } else {
    html += `<div style="color:#888;">No Time In/Out records found.</div>`;
  }

  // 2. Daily Logs
  const dailyLogs = await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/dailylogs/${userId}`).then(r => r.ok ? r.json() : []);
  let filteredLogs = dailyLogs;
  if (range === "daily") {
    const today = new Date().toLocaleDateString();
    filteredLogs = dailyLogs.filter(log =>
      log.date && new Date(log.date).toLocaleDateString() === today
    );
  } else if (range === "weekly") {
    const now = new Date();
    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    filteredLogs = dailyLogs.filter(log =>
      log.date && new Date(log.date) >= weekAgo
    );
  } else if (range === "monthly") {
    const now = new Date();
    const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
    filteredLogs = dailyLogs.filter(log =>
      log.date && new Date(log.date) >= monthAgo
    );
  }
  html += `<h4>Daily Logs</h4>`;
  if (filteredLogs.length === 0) {
    html += `<div style="color:#888;">No daily logs found for this range.</div>`;
  } else {
    html += `<ul style="margin:0 0 1em 1em;">` +
      filteredLogs.map(log =>
        `<li>
          <b>${log.title || ""}</b> <br>
          <span style="color:#888;">${log.date ? new Date(log.date).toLocaleString() : ""}</span><br>
          <span>${log.desc || ""}</span>
          ${log.img ? `<br><img src="${log.img}" alt="Activity photo" style="max-width:160px;max-height:120px;margin:5px 0;border-radius:8px;border:1px solid #ccc;">` : ""}
        </li>`
      ).join('') + `</ul>`;
  }

  // 3. Uploaded Requirements
  const reqTypes = [
    {id: "Resume", label: "Resume"},
    {id: "Endorsement", label: "Endorsement Letter"},
    {id: "Idpic", label: "2x2 ID Picture"},
    {id: "Medical", label: "Medical Certificate"},
    {id: "Waiver", label: "Waiver"},
    {id: "InternApp", label: "STUDENT INTERNS Application Form"},
    {id: "Contract", label: "INTERNSHIP CONTRACT/AGREEMENT"},
    {id: "Acceptance", label: "INTERNSHIP ACCEPTANCE LETTER"},
    {id: "Insurance", label: "INSURANCE"},
    {id: "Moa", label: "MOA"}
  ];
  const requirements = await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/requirements/${userId}`).then(r => r.ok ? r.json() : []);
  html += `<h4>Uploaded Requirements</h4>`;
  if (requirements.length === 0) {
    html += `<div style="color:#888;">No requirements uploaded yet.</div>`;
  } else {
    html += `<ul style="margin:0 0 1em 1em;">`;
    reqTypes.forEach(({id, label}) => {
      const file = requirements.find(f => f.type.toLowerCase() === id.toLowerCase());
      if (file) {
        const fileUrl = `https://slsu-ojt-monitoring-system-1.onrender.com/requirements/${file.filename}`;
        html += `<li><b>${label}:</b> <a href="${fileUrl}" target="_blank" style="color:#2299ee;">View/Download</a></li>`;
      } else {
        html += `<li><b>${label}:</b> <span style="color:#bbb;">Not uploaded</span></li>`;
      }
    });
    html += `</ul>`;
  }

  // 4. FAQs
  const faqs = await fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/faqs').then(r => r.ok ? r.json() : []);
  const userFaqs = faqs.filter(f => `${f.userId}` === `${userId}`);
  html += `<h4>FAQs</h4>`;
  if (userFaqs.length === 0) {
    html += `<div style="color:#888;">No FAQs found for this user.</div>`;
  } else {
    html += `<ul style="margin:0 0 1em 1em;">` +
      userFaqs.map(faq =>
        `<li>
          <b>Q:</b> ${faq.question} <br>
          <span style="color:#888;">${faq.date ? new Date(faq.date).toLocaleString() : ""}</span>
          ${faq.img ? `<br><img src="${faq.img}" alt="FAQ photo" style="max-width:140px;max-height:100px;margin:5px 0;border-radius:8px;border:1px solid #ccc;">` : ""}
        </li>`
      ).join('') + `</ul>`;
  }

  document.getElementById('userReportResult').innerHTML = html;
}


async function showUserWeeklyLogs() {
  const userId = localStorage.getItem('currentUserId');
  const logs = await getOjtLogs(userId);
  if (!userId || logs.length === 0) {
    document.getElementById('userWeeklyLogsResult').innerHTML = "<div style='color:#888;'>No logs available.</div>";
    return;
  }
  let grouped = {};
  logs.forEach(log => {
    if (!log.clockIn) return;
    let d = new Date(log.clockIn);
    let week = getISOWeek(d);
    let year = d.getFullYear();
    let key = `${year}-W${week}`;
    if (!grouped[key]) grouped[key] = [];
    grouped[key].push(log);
  });
  let html = "<h4 style='margin-bottom:1em;'>Weekly Log Summary</h4>";
  Object.keys(grouped).sort().reverse().forEach(week => {
    html += `<div style="margin-bottom:1.2em;"><b>${week}</b><ul style="margin:.5em 0 0 1em;">`;
    grouped[week].forEach(log => {
      html += `<li>${log.clockIn ? new Date(log.clockIn).toLocaleString() : '-'}  ${log.clockOut ? new Date(log.clockOut).toLocaleString() : '-'} (${log.clockIn && log.clockOut ? (((new Date(log.clockOut)-new Date(log.clockIn))/3600000).toFixed(2) + ' hrs') : ''})</li>`;
    });
    html += `</ul></div>`;
  });
  document.getElementById('userWeeklyLogsResult').innerHTML = html;
}

// Helper to get ISO week number
function getISOWeek(date) {
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
}

async function exportUserReportPDF() {
  try {
    const { jsPDF } = window.jspdf;
    if (!jsPDF) throw new Error("jsPDF not loaded");

    const reportElement = document.getElementById("userReportResult");
    if (!reportElement) throw new Error("No report to export");

    // Ensure all resources (like images) are loaded
    await new Promise((resolve) => {
      if (document.readyState === "complete") resolve();
      else window.onload = resolve;
    });

    const doc = new jsPDF({ orientation: "p", unit: "pt", format: "a4" });

    await doc.html(reportElement, {
      callback: (doc) => {
        doc.save("user-report.pdf");
      },
      html2canvas: {
        scale: 0.8,
        useCORS: true
      },
      margin: [20, 20, 20, 20],
      autoPaging: "text"
    });

  } catch (err) {
    console.error("PDF export failed:", err);
    alert("Failed to export PDF. Please check the console for details.");
  }
}


function exportUserReportDOCX() {
  const html = document.getElementById('userReportResult').innerHTML;
  const converted = window.htmlDocx.asBlob('<html><body>' + html + '</body></html>');
  const link = document.createElement('a');
  link.href = URL.createObjectURL(converted);
  link.download = 'user-report.docx';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

async function showCollaboratorsPanel(cls) {
  // Show panel
  document.getElementById('classCollaboratorsPanel').style.display = '';
  // Fetch collaborators from backend (replace with your actual API)
  const res = await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/classes/${cls.id}/admins`);
  const admins = await res.json();
  const list = document.getElementById('collaboratorsList');
  list.innerHTML = admins.map(a =>
    `<li style="margin-bottom:10px;">
      <b>${a.name || a.email}</b> 
      (${a.role}) 
      ${a.role !== 'owner' && (isCurrentAdminOwner(admins)) ? 
        `<button onclick="removeCollaborator('${a.email}')"
          style="margin-left:8px;background:#e74c3c;color:#fff;border:none;border-radius:6px;padding:3px 10px;font-size:.95em;cursor:pointer;">
          <i class="fas fa-user-minus"></i> Remove
        </button>`: ''}
    </li>`
  ).join('');
  // If current admin is not owner, hide add form
  document.getElementById('addCollaboratorForm').style.display =
    isCurrentAdminOwner(admins) ? 'flex' : 'none';
}

function isCurrentAdminOwner(admins) {
  // Replace with your current admin logic!
  const currentEmail = localStorage.getItem("loggedInAdmin");
  return admins.find(a => a.email === currentEmail && a.role === 'owner');
}

async function addCollaborator() {
  const email = document.getElementById("collabEmailInput").value.trim();
  const role = document.getElementById("collabRoleInput").value;
  const courseId = document.getElementById("classCollaboratorsPanel").dataset.classId;

  if (!email) {
    document.getElementById("collabMsg").innerText = " Please enter an email.";
    return;
  }

  try {
    const res = await fetch("https://slsu-ojt-monitoring-system-1.onrender.com/api/collaborators", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ courseId, email, role })
    });

    const data = await res.json();
    if (res.ok) {
      document.getElementById("collabMsg").innerText = " Collaborator added!";
      document.getElementById("collabEmailInput").value = "";
      // Immediately refresh collaborators from backend:
      await refreshCollaborators(courseId);
    } else {
      document.getElementById("collabMsg").innerText = " " + (data.error || "Could not add collaborator");
    }
  } catch (err) {
    document.getElementById("collabMsg").innerText = " Network error: " + err.message;
  }
}

async function refreshCollaborators(courseId) {
  const res = await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/collaborators/${courseId}`);
  const collaborators = await res.json();
  localStorage.setItem("collaborators", JSON.stringify(collaborators));
  renderCollaboratorsUI();
}


  // Render collaborators for a class and show a Remove button for each
  async function renderCollaborators(classId) {
    try {
      const res = await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/collaborators/${classId}`);
      if (!res.ok) {
        console.error('Failed to load collaborators', res.status);
        document.getElementById('collaboratorsList').innerHTML = '<li style="color:#e74c3c;">Failed to load collaborators</li>';
        return;
      }
      const collaborators = await res.json();
      const list = document.getElementById('collaboratorsList');
      if (!list) return;

      if (!Array.isArray(collaborators) || collaborators.length === 0) {
        list.innerHTML = '<li>No collaborators yet.</li>';
        return;
      }

      list.innerHTML = collaborators.map(c => {
        // sanitize display text minimally to avoid HTML injection
        const email = String(c.email || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const role = c.role ? `(${String(c.role).replace(/</g,'&lt;')})` : '';
        // collaborator.id must be present (your DB SELECT * returns it)
        return `
          <li style="margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;">
            <div style="font-weight:600;color:#223046;">${email} <span style="font-weight:500;color:#666;margin-left:8px;">${role}</span></div>
            <div>
              <button
                onclick="removeCollaborator(${c.id}, ${classId})"
                style="background:#e74c3c;color:#fff;border:none;border-radius:6px;padding:6px 10px;font-size:.95em;cursor:pointer;">
                <i class="fas fa-user-minus"></i> Remove
              </button>
            </div>
          </li>
        `;
      }).join('');
    } catch (err) {
      console.error('renderCollaborators error', err);
      const list = document.getElementById('collaboratorsList');
      if (list) list.innerHTML = '<li style="color:#e74c3c;">Error loading collaborators</li>';
    }
  }

  // Remove collaborator by DB id, refresh the collaborator list for the class
  async function removeCollaborator(collabId, classId) {
    if (!collabId) return alert('Invalid collaborator id');
    if (!confirm('Remove this collaborator?')) return;

    try {
      const res = await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/collaborators/${collabId}`, {
        method: 'DELETE'
      });
      const body = await res.json().catch(() => ({}));

      if (!res.ok) {
        console.error('Delete failed', body);
        return alert('Failed to remove collaborator: ' + (body.error || res.status));
      }

      // refresh displayed list
      await renderCollaborators(classId);

      // try refreshing any cached collaborators UI/data
      if (typeof refreshCollaborators === 'function') {
        try { await refreshCollaborators(classId); } catch (e) { /* ignore */ }
      }

      // show ephemeral success message
      const msgEl = document.getElementById('collabMsg');
      if (msgEl) {
        msgEl.style.color = '#25a55f';
        msgEl.innerText = 'Collaborator removed';
        setTimeout(() => { msgEl.innerText = ''; }, 2500);
      }
    } catch (err) {
      console.error('removeCollaborator error', err);
      alert('Network error while removing collaborator.');
    }
  }

  // Ensure the collaborators panel loads the list for the selected class
  document.addEventListener('DOMContentLoaded', () => {
    const collabSelect = document.getElementById('collabClassSelect');
    if (collabSelect) {
      collabSelect.addEventListener('change', function() {
        const classId = Number(this.value);
        if (classId) renderCollaborators(classId);
      });
      // initial render:
      const initial = Number(collabSelect.value);
      if (initial) renderCollaborators(initial);
    }
  });


function renderCollaboratorsUI() {
  const collaborators = JSON.parse(localStorage.getItem("collaborators") || "[]");
  const list = document.getElementById("collaboratorsList");
  if (!list) return;
  list.innerHTML = collaborators.length
    ? collaborators.map(c => `<li>${c.email} (${c.role})</li>`).join('')
    : "<li>No collaborators yet.</li>";
  document.getElementById('classCollaboratorsPanel').style.display = 'block';
}


function openCollaborators(classId) {
  const panel = document.getElementById("classCollaboratorsPanel");
  panel.style.display = "block";
  panel.dataset.classId = classId;  //  Save class ID for Add button

  fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/classes/${classId}/admins`)
    .then(res => res.json())
    .then(collabs => {
      const list = document.getElementById("collaboratorsList");
      list.innerHTML = "";
      collabs.forEach(c => {
        const li = document.createElement("li");
        li.innerHTML = `
          ${c.name || c.email} - <b>${c.role}</b>
          <button onclick="removeCollaborator(${classId}, '${c.email}')"></button>
        `;
        list.appendChild(li);
      });
    });
}

async function sendOTP() {
  const email = document.getElementById("newAdminEmail").value.trim();
  if (!email) {
    alert("Please enter an institutional email first.");
    return;
  }

  try {
    const res = await fetch("https://slsu-ojt-monitoring-system-1.onrender.com/api/request-otp", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email })
    });
    const data = await res.json();
    if (res.ok) {
      alert("OTP sent to your email. Check your inbox!");
    } else {
      alert("Error: " + data.error);
    }
  } catch (err) {
    alert("Network error: " + err.message);
  }
}






reqTypes.forEach(({id}) => {
  const fileInput = document.getElementById('req' + id);
  const chk = document.getElementById('chk' + id);
  if (fileInput && chk) {
    fileInput.addEventListener('change', function() {
      chk.checked = !!fileInput.files.length;
    });
  }
});

function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}


async function populateCollabClassSelect() {
  const select = document.getElementById('collabClassSelect');
  select.innerHTML = '';
  const admin = localStorage.getItem("loggedInAdmin");
  if (!admin) {
    select.innerHTML = '<option value="">Please login as admin</option>';
    return;
  }
  try {
    const res = await fetch(`https://slsu-ojt-monitoring-system-1.onrender.com/api/classes?admin=${encodeURIComponent(admin)}`);
    const classes = await res.json();
    if (!Array.isArray(classes) || classes.length === 0) {
      select.innerHTML = '<option value="">No classes available</option>';
      return;
    }
    classes.forEach(cls => {
      const opt = document.createElement('option');
      opt.value = cls.id;
      const assignedSuffix = (cls && (cls.assignedOnly === 1 || cls.assignedOnly === true)) ? ' (assigned)' : '';
      opt.textContent = `${cls.course} (${cls.section}) - OJT: ${cls.hours}${assignedSuffix}`;
      select.appendChild(opt);
    });
    select.value = classes[0].id;
    await renderCollaborators(classes[0].id);
  } catch (err) {
    select.innerHTML = '<option value="">Error loading classes</option>';
    console.error(err);
  }
}


// Add collaborator to selected class
async function addCollaborator() {
  const classId = document.getElementById('collabClassSelect').value;
  const email = document.getElementById('collabEmailInput').value.trim();
  const role = document.getElementById('collabRoleInput').value;
  if (!classId || !email) {
    document.getElementById('collabMsg').innerText = "Please select a class and enter an email.";
    return;
  }
  const res = await fetch("https://slsu-ojt-monitoring-system-1.onrender.com/api/collaborators", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ courseId: classId, email, role })
  });
  if (res.ok) {
    document.getElementById('collabMsg').innerText = " Collaborator added!";
    document.getElementById('collabEmailInput').value = "";
    await renderCollaborators(classId);
  } else {
    const data = await res.json();
    document.getElementById('collabMsg').innerText = " " + (data.error || "Could not add collaborator");
  }
}

// Call on panel open or page load:
document.addEventListener('DOMContentLoaded', populateCollabClassSelect);


function toggleClassOptionsMenu(event, classId) {
  event.stopPropagation();
  document.querySelectorAll('.class-options-menu').forEach(menu => menu.style.display = 'none');
  const menu = document.getElementById(`class-options-menu-${classId}`);
  if (menu) menu.style.display = (menu.style.display === 'block' ? 'none' : 'block');
}
document.addEventListener('click', function() {
  document.querySelectorAll('.class-options-menu').forEach(menu => menu.style.display = 'none');
});

async function deleteClassConfirm(classId) {
  if (!confirm("Are you sure you want to delete this class?")) return;
  await deleteClass(classId);
}

async function excelStudentUpload(event) {
  const file = event.target.files[0];
  if (!file) {
    alert("No file selected!");
    return;
  }
  const reader = new FileReader();
  reader.onload = async function(e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, {type: 'array'});
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    // Convert sheet to JSON
    const students = XLSX.utils.sheet_to_json(sheet);
    // For each student, send to backend
    for (const s of students) {
      // Map columns as needed!
      const student = {
        last: s["Last Name"] || s.last || "",
        first: s["First Name"] || s.first || "",
        middle: s["Middle Name"] || s.middle || "",
        ext: s["Extension"] || s.ext || "",
        dept: s["Department"] || s.dept || "",
        studid: s["School ID"] || s.studid || "",
        email: s["Email"] || s.email || "",
        password: s["Password"] || s.password || "",
        classId: currentClassId
      };
      try {
        const res = await fetch('https://slsu-ojt-monitoring-system-1.onrender.com/api/students', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(student)
        });
        if (!res.ok) {
          const data = await res.json();
          console.warn("Failed to enroll student:", student, data);
        }
      } catch (err) {
        console.error("Network error enrolling student:", student, err);
      }
    }
    alert(`Uploaded ${students.length} students!`);
    // Optionally refresh student list
    if (typeof renderStudentListTab === "function") renderStudentListTab();
  };
  reader.readAsArrayBuffer(file);
}

function clearEditClassModal() {
  document.getElementById('editClassName').value = '';
  document.getElementById('editClassSection').value = '';
  document.getElementById('editClassHours').value = '';
  document.getElementById('editClassModal').style.display = 'none';
  document.getElementById('editClassModal').dataset.classId = '';
}

window.editClass = editClass;
window.saveClassEdits = saveClassEdits;
window.clearEditClassModal = clearEditClassModal;

  </script>
</body>
</html>

